name: Sub-Store Integration Final 24
on:
  workflow_dispatch:

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. å‡†å¤‡ä¸æ£€æŸ¥è·¯å¾„
        run: |
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output
          if [ -f "${{ github.workspace }}/config/config.yaml" ]; then
            echo "âœ… å‘ç°ä»“åº“é…ç½®æ–‡ä»¶: ${{ github.workspace }}/config/config.yaml"
            sudo chmod 644 ${{ github.workspace }}/config/config.yaml
          else
            echo "âŒ é”™è¯¯ï¼šä»“åº“ä¸­æœªæ‰¾åˆ° config/config.yaml"
            exit 1
          fi

      - name: 3. å¯åŠ¨å®¹å™¨ (ç²¾ç¡®æŒ‚è½½)
        run: |
          echo "ğŸš€ æ­£åœ¨å¯åŠ¨å®¹å™¨..."
          docker run --name checker -d \
            -p 8199:8199 -p 8299:8299 \
            -v ${{ github.workspace }}/config/config.yaml:/app/config/config.yaml \
            -v ${{ github.workspace }}/config/config.yaml:/app/config.yaml \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master

      - name: 4. å»ºç«‹åŒè·¯éš§é“
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://127.0.0.1:8199 --logfile tunnel_8199.log > /dev/null 2>&1 &
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel_8299.log > /dev/null 2>&1 &
          sleep 10
          URL_8199=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel_8199.log | head -n 1)
          echo "------------------------------------------------"
          echo "ğŸŒ ç®¡ç†é¢æ¿: $URL_8199/admin"
          echo "------------------------------------------------"

      - name: 5. å®æ—¶æ£€æµ‹è¿›åº¦ä¸å“¨å…µåŒæ­¥
        env:
          MY_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # ã€æ ¸å¿ƒæ”¹è¿›ã€‘å¯åŠ¨å®æ—¶æ—¥å¿—è§‚å¯Ÿè€…
          # å®ƒä¼šæŠŠå®¹å™¨é‡Œçš„æ£€æµ‹è¿›åº¦ç›´æ¥æ‰“å°åˆ° Action çš„å½“å‰çª—å£
          echo "ğŸ“¡ æ­£åœ¨åŒæ­¥å®¹å™¨æ£€æµ‹è¿›åº¦..."
          docker logs -f checker & 

          LAST_MARK=""
          # å¾ªç¯ç›‘æ§
          for i in {30..1}; do
            if ! docker ps | grep -q 'checker'; then 
              echo "âŒ å®¹å™¨å·²åœæ­¢"
              break
            fi
            
            # æ£€æŸ¥æ˜¯å¦å®Œæˆ
            CUR_MARK=$(docker logs checker 2>&1 | grep "æ£€æµ‹å®Œæˆ" | tail -n 1)
            if [ -n "$CUR_MARK" ] && [ "$CUR_MARK" != "$LAST_MARK" ]; then
              echo "ğŸ¯ æ•è·å­˜ç›˜ä¿¡å·ï¼ŒåŒæ­¥ä¸­..."
              LAST_MARK="$CUR_MARK"
              if [ -s "${{ github.workspace }}/output/all.yaml" ]; then
                cp -f ${{ github.workspace }}/output/all.yaml ./all.yaml
                git config --global user.email "action@github.com"
                git config --global user.name "GitHub Action"
                git add all.yaml
                git commit -m "Auto Update Nodes" || true
                git push --quiet "https://x-access-token:${MY_TOKEN}@github.com/${{ github.repository }}.git" HEAD:main
                echo "âœ… ä»“åº“åŒæ­¥åœ†æ»¡å®Œæˆï¼å¯ä»¥æ‰‹åŠ¨åœæ­¢ä»»åŠ¡äº†ã€‚"
              fi
            fi
            
            echo "â³ å­˜æ´»ç›‘æ§ä¸­ ($i/30 åˆ†é’Ÿ)..."
            sleep 60
          done
