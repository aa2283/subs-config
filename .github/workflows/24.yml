name: Sub-Store Official UI Sync
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. å‡†å¤‡ç›®å½•
        run: |
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output

      - name: 3. å¯åŠ¨åç«¯å®¹å™¨ (8299)
        run: |
          # å¯åŠ¨å®¹å™¨ï¼Œåªæ˜ å°„ 8299 åç«¯ç«¯å£
          docker run --name sub-backend -d \
            -p 8299:8299 \
            -v ${{ github.workspace }}/config/config.yaml:/app/config/config.yaml \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master

          sleep 5
          docker logs sub-backend

      - name: 4. å¼€å¯ API éš§é“å¹¶ç”Ÿæˆå‰ç«¯é“¾æ¥
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          
          # å»ºç«‹ 8299 éš§é“
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel.log > /dev/null 2>&1 &
          
          sleep 15
          API_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)

          echo "------------------------------------------------"
          echo "âœ… åç«¯ API éš§é“å·²å°±ç»ªï¼"
          echo "ğŸŒ å®˜æ–¹å‰ç«¯è¿æ¥åœ°å€ (ç‚¹å‡»å³å¯è¿›å…¥):"
          echo "https://sub-store.vercel.app?api=$API_URL"
          echo "------------------------------------------------"

      - name: 5. å®æ—¶åŒæ­¥ä¸æŒç»­æŒ‚æœº
        env:
          MY_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # æŒç»­æ‰“å°åç«¯æ—¥å¿—
          docker logs -f sub-backend & 

          LAST_MARK=""
          # æŒ‚æœº 60 åˆ†é’Ÿï¼Œç¡®ä¿ä½ åœ¨ç½‘é¡µä¸Šæ“ä½œæ—¶åç«¯ä¸€ç›´åœ¨çº¿
          for i in {60..1}; do
            if ! docker ps | grep -q 'sub-backend'; then break; fi
            
            # è‡ªåŠ¨æ•è·æ£€æµ‹å®Œæˆä¿¡å·å¹¶åŒæ­¥ä»“åº“
            CUR_MARK=$(docker logs sub-backend 2>&1 | grep "æ£€æµ‹å®Œæˆ" | tail -n 1)
            if [ -n "$CUR_MARK" ] && [ "$CUR_MARK" != "$LAST_MARK" ]; then
              echo "ğŸ¯ æ£€æµ‹å®Œæˆï¼Œæ­£åœ¨åŒæ­¥ç»“æœåˆ° GitHub..."
              LAST_MARK="$CUR_MARK"
              if [ -s "output/all.yaml" ]; then
                cp -f output/all.yaml ./all.yaml
                git config --global user.email "bot@github.com"
                git config --global user.name "AutoBot"
                git add all.yaml
                git commit -m "Auto Update Nodes" || true
                git push origin HEAD:${{ github.ref_name }}
                echo "âœ… all.yaml å·²åŒæ­¥å›ä»“åº“ï¼"
              fi
            fi
            sleep 60
          done
