name: Sub-Store 8299 Fixed
on:
  workflow_dispatch:

# å¿…é¡»å£°æ˜æ­¤æƒé™ï¼Œå¦åˆ™ Git Push ä¼šæŠ¥ 403
permissions:
  contents: write

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 2. å‡†å¤‡ç›®å½•
        run: |
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output

      - name: 3. å¯åŠ¨å®¹å™¨ (8299 ä¸ºä¸»)
        run: |
          docker run --name checker -d \
            -p 8299:8299 \
            -v ${{ github.workspace }}/config/config.yaml:/app/config/config.yaml \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master

      - name: 4. å»ºç«‹ 8299 éš§é“
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          
          # ä»…ä¸º 8299 å¼€å¯éš§é“
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel_8299.log > /dev/null 2>&1 &
          
          sleep 10
          URL_8299=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel_8299.log | head -n 1)

          echo "------------------------------------------------"
          echo "âœ… Sub-Store æ ¸å¿ƒæœåŠ¡éš§é“å·²å¼€é€šï¼š"
          echo "ğŸŒ è®¢é˜…è®¿é—®åœ°å€: $URL_8299/sub/ACL4SSR_Online_Full.yaml"
          echo "------------------------------------------------"

      - name: 5. å®æ—¶æ£€æµ‹ä¸è‡ªåŠ¨æ¨é€
        run: |
          # å®æ—¶æŠŠå®¹å™¨å†…çš„æµ‹é€Ÿè¿›åº¦åˆ·åˆ° Action æ§åˆ¶å°
          docker logs -f checker & 

          LAST_MARK=""
          # ç›‘æ§æ£€æµ‹çŠ¶æ€
          for i in {30..1}; do
            if ! docker ps | grep -q 'checker'; then break; fi
            
            # åŒ¹é…æ£€æµ‹å®Œæˆçš„æ ‡å¿—
            CUR_MARK=$(docker logs checker 2>&1 | grep "æ£€æµ‹å®Œæˆ" | tail -n 1)
            
            if [ -n "$CUR_MARK" ] && [ "$CUR_MARK" != "$LAST_MARK" ]; then
              echo "ğŸ¯ æ£€æµ‹å·²å®Œæˆï¼Œæ­£åœ¨åŒæ­¥ç»“æœåˆ°ä»“åº“..."
              LAST_MARK="$CUR_MARK"
              
              if [ -s "output/all.yaml" ]; then
                cp -f output/all.yaml ./all.yaml
                
                # Git æ¨é€é…ç½®
                git config --global user.email "github-actions[bot]@users.noreply.github.com"
                git config --global user.name "github-actions[bot]"
                git add all.yaml
                git commit -m "Auto Update: $(date +'%Y-%m-%d %H:%M')" || exit 0
                git push origin HEAD:${{ github.ref_name }}
                echo "âœ… all.yaml å·²æ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“ï¼"
                # æˆåŠŸåå¯ä»¥é€‰æ‹©ç»“æŸä»»åŠ¡
                exit 0
              fi
            fi
            sleep 30
          done
