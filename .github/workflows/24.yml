name: Sub-Store 8299 Permanent Tunnel
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 2. å‡†å¤‡ç›®å½•
        run: |
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output

      - name: 3. å¯åŠ¨å®¹å™¨
        run: |
          docker run --name checker -d \
            -p 8299:8299 \
            -v ${{ github.workspace }}/config/config.yaml:/app/config/config.yaml \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master

      - name: 4. å»ºç«‹ 8299 æ°¸ä¹…éš§é“
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          
          # å¼€å¯éš§é“å¹¶è®°å½•æ—¥å¿—
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel_8299.log > /dev/null 2>&1 &
          
          sleep 10
          URL_8299=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel_8299.log | head -n 1)

          echo "------------------------------------------------"
          echo "âœ… éš§é“å·²é”å®šï¼Œè®¿é—®åœ°å€ï¼š"
          echo "ğŸŒ è®¢é˜…: $URL_8299/sub/ACL4SSR_Online_Full.yaml"
          echo "------------------------------------------------"

      - name: 5. å®æ—¶æ£€æµ‹ã€åŒæ­¥å¹¶æŒç»­æŒ‚æœº
        run: |
          # 1. å¯åŠ¨å®æ—¶æ—¥å¿—æµ
          docker logs -f checker & 

          LAST_MARK=""
          # 2. è¿›å…¥é•¿å¾ªç¯ (æ¯”å¦‚è®¾ç½® 60 åˆ†é’Ÿ)
          for i in {60..1}; do
            # æ£€æŸ¥å®¹å™¨çŠ¶æ€
            if ! docker ps | grep -q 'checker'; then 
              echo "âš ï¸ å®¹å™¨æ„å¤–åœæ­¢ï¼Œå°è¯•æŸ¥çœ‹åŸå› ..."
              docker logs checker --tail 20
              break
            fi
            
            # æ£€æµ‹æ˜¯å¦å®Œæˆ
            CUR_MARK=$(docker logs checker 2>&1 | grep "ä¿å­˜æœ¬åœ°æˆåŠŸ" | tail -n 1)
            
            # å¦‚æœä¿å­˜æœ¬åœ°æˆåŠŸä¸”å°šæœªåŒæ­¥ï¼Œåˆ™æ‰§è¡ŒåŒæ­¥
            if [ -n "$CUR_MARK" ] && [ "$CUR_MARK" != "$LAST_MARK" ]; then
              echo "ğŸ¯ ä¿å­˜æœ¬åœ°æˆåŠŸä¿¡å·æ•æ‰æˆåŠŸï¼Œå¼€å§‹åå°åŒæ­¥..."
              LAST_MARK="$CUR_MARK"
              
              if [ -s "output/all.yaml" ]; then
                cp -f output/all.yaml ./all.yaml
                git config --global user.email "github-actions[bot]@users.noreply.github.com"
                git config --global user.name "github-actions[bot]"
                git add all.yaml
                git commit -m "Auto Update: $(date +'%Y-%m-%d %H:%M')" || echo "No changes to commit"
                git push origin HEAD:${{ github.ref_name }} && echo "âœ… ä»“åº“åŒæ­¥å·²å®Œæˆï¼Œéš§é“ç»§ç»­ä¿æŒ..."
              fi
            fi

            # æ¯åˆ†é’Ÿæ‰“å°ä¸€æ¬¡å¿ƒè·³ï¼Œé˜²æ­¢ Action å› ä¸ºæ— è¾“å‡ºè¢«å…³é—­
            if [ $((i % 5)) -eq 0 ]; then
              echo "â³ éš§é“åŠæŒ‚æœºé”å­˜æ´»ä¸­... å‰©ä½™ $i åˆ†é’Ÿ"
            fi
            sleep 60
          done
