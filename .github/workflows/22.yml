name: Subs-Check & Sub-Store ç»ˆæç¼åˆä¿®å¤ç‰ˆ

on:
  schedule:
    - cron: '15 4 * * *'
  workflow_dispatch:

jobs:
  check-subscriptions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: 1. æ£€å‡ºä¸»ä»“åº“
        uses: actions/checkout@v4

      - name: 2. è¿è¡Œæ£€æµ‹å™¨ (åå°å¸¸é©»æ¨¡å¼)
        run: |
          mkdir -p output temp_config sub-store-data
          chmod -R 777 output

          echo "output/" >> .gitignore
          echo "*.log" >> .gitignore
          
          # Python æ³¨å…¥ (ä¿æŒä½ åŸæ¥çš„ä»£ç )
          export RAW_URLS_DATA="${{ secrets.SUB_URLS }}"
          python3 -c "
          import os
          template_path = 'config/config.yaml'
          output_path = 'temp_config/config.yaml'
          raw_urls = os.environ.get('RAW_URLS_DATA', '').strip().split('\n')
          formatted_urls = [f'  - \"{u.strip()}\"\n' for u in raw_urls if len(u.strip()) > 10]
          new_lines = ['show-useless-url: true\n']
          with open(template_path, 'r', encoding='utf-8') as f:
              for line in f:
                  if '{SUB_URLS}' in line: new_lines.extend(formatted_urls)
                  elif 'show-useless-url' in line: continue
                  else: new_lines.append(line)
          with open(output_path, 'w', encoding='utf-8') as f:
              f.writelines(new_lines)
          "

          # å¯åŠ¨å®¹å™¨ï¼šå¢åŠ å†…å­˜é™åˆ¶åº”å¯¹ 9000 èŠ‚ç‚¹
          docker run -d --name checker \
            -e NODE_OPTIONS="--max-old-space-size=4096" \
            -v ${{ github.workspace }}/temp_config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            -p 8299:8299 ghcr.io/aa2283/subs-check:master

          # å®æ—¶å¼•æµæ—¥å¿—ï¼Œè§£å†³â€œä¸è§æ£€æµ‹â€
          docker logs -f checker &

      - name: 3. æ£€å‡ºç›®æ ‡ä»“åº“ (æŒ‡å®šè·¯å¾„é˜²æ­¢æ¸…ç†)
        uses: actions/checkout@v4
        with:
          repository: aa2283/v2ray_configs
          token: ${{ secrets.PAT_TOKEN }}
          path: target-repo-sync

      - name: 4. å¼€å¯éš§é“å¹¶åŠ¨æ€æå–
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          touch backend.log
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile backend.log > tunnel.log 2>&1 &
          
          for i in {1..30}; do
            API_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' backend.log tunnel.log 2>/dev/null | head -n 1)
            if [ -n "$API_URL" ]; then
              echo "::add-mask::$API_URL"
              echo "FINAL_API_URL=$API_URL" >> $GITHUB_ENV
              echo "âœ… éš§é“å»ºç«‹: $API_URL"
              break
            fi
            sleep 3
          done

      - name: 5. åŠ¨æ€åŸŸåä¸ŠæŠ¥ (ä¿æŒåŸæ ·)
        env:
          MY_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # ... (æ­¤å¤„æ”¾ä½ åŸæœ¬çš„åŸŸååŒæ­¥ curl API é€»è¾‘) ...
          echo "åŸŸåå·²ä¸ŠæŠ¥"

      - name: 6. ç²¾å‡†ç›‘å¬ä¸‹è½½å¹¶å®æ—¶æ¨é€ (é€»è¾‘ä¿®å¤)
        env:
          MY_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # å¤ºå›æƒé™ï¼Œé˜²æ­¢ Permission denied
          sudo chown -R $USER:$GROUP ${{ github.workspace }}/output
          mkdir -p subs
          for i in {1..15}
          do
            echo ">>> ç¬¬ $i/15 æ¬¡æ£€æŸ¥ (8299 ç«¯å£)..."
            
            # A. å°è¯•é€šè¿‡ç½‘ç»œæ¥å£ä¸‹è½½ (Sub-Store è½¬æ¢)
            # æ³¨æ„ï¼šå¯¹äº 9000 èŠ‚ç‚¹ï¼Œå¢åŠ è¶…æ—¶æ—¶é—´
            curl -s --connect-timeout 20 "http://127.0.0.1:8299/download/sub?target=ClashMeta" -o subs/new_clash.yaml || echo "ç½‘ç»œæ¥å£è¶…æ—¶"

            # B. ç‰©ç†ä¿åº• (å¦‚æœ API æŒ‚äº†ï¼Œç›´æ¥ä»ç£ç›˜æ‹¿æµ‹é€Ÿç»“æœ)
            if [ ! -s "subs/new_clash.yaml" ] && [ -f "output/all.yaml" ]; then
                echo "âš ï¸ å¯ç”¨ç‰©ç†ä¿åº•åŒæ­¥"
                cp -f output/all.yaml subs/new_clash.yaml
            fi

            # C. å˜åŠ¨æ£€æŸ¥ä¸æ¨é€
            if [ -s "subs/new_clash.yaml" ] && grep -q "proxies" subs/new_clash.yaml; then
                echo "ğŸ“¢ æ£€æµ‹åˆ°æ•°æ®æ›´æ–°ï¼ŒåŒæ­¥ä¸­..."
                
                # åŒæ­¥åˆ°å½“å‰ä»“åº“
                cp -f output/all.yaml ./all.yaml
                git add all.yaml  # ğŸ‘ˆ åªæ·»åŠ è¿™ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸è¦ add æ•´ä¸ªç›®å½•
                git commit -m "Auto Update" || echo "æ— å˜åŠ¨"
                git config --local user.email "actions@github.com"
                git config --local user.name "GitHub Action"
                cp -f subs/new_clash.yaml ./all.yaml
                git add all.yaml
                git commit -m "Auto Update: $(date +'%H:%M:%S')" || echo ""
                git push origin main

                # åŒæ­¥åˆ°ç›®æ ‡ä»“åº“ (target-repo-sync)
                cp -f subs/new_clash.yaml target-repo-sync/subs/all.yaml
                cd target-repo-sync
                git config --local user.email "actions@github.com"
                git config --local user.name "GitHub Action"
                git add all.yaml
                git commit -m "Sync: $(date +'%H:%M:%S')" || echo ""
                git push origin main
                cd ..
                
                # å¤‡ä»½çµé­‚æ–‡ä»¶
                docker cp checker:/app/output/sub-store.json ./sub-store-data/sub-store.json || true
                echo "âœ… åŒæ­¥åœ†æ»¡å®Œæˆ"
            fi
            
            sleep 60
          done

      - name: 7. å–„å
        if: always()
        run: |
          docker rm -f checker || true
          pkill cloudflared || true
