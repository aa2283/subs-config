name: Subscription Checker ç»ˆæç¼åˆç‰ˆ on: schedule: - cron: '15 4 * * *' workflow_dispatch: jobs: check-subscriptions: runs-on: ubuntu-latest steps: - name: 1. ç¯å¢ƒåˆå§‹åŒ– uses: actions/checkout@v4 with: clean: false - name: 2. å‡†å¤‡é…ç½®å¹¶åå°å¯åŠ¨æ£€æµ‹ run: | # A. å‡†å¤‡å·¥ä½œç›®å½• mkdir -p ${{ github.workspace }}/output mkdir -p ${{ github.workspace }}/temp_config chmod -R 777 ${{ github.workspace }}/output # B. Python æ³¨å…¥é€»è¾‘ (ä¿æŒåŸæ ·) export RAW_URLS_DATA="${{ secrets.SUB_URLS }}" python3 -c " import os template_path = '${{ github.workspace }}/config/config.yaml' output_path = '${{ github.workspace }}/temp_config/config.yaml' raw_urls = os.environ.get('RAW_URLS_DATA', '').strip().split('\n') formatted_urls = [f' - \"{u.strip()}\"\n' for u in raw_urls if len(u.strip()) > 10] new_lines = ['show-useless-url: true\n'] with open(template_path, 'r', encoding='utf-8') as f: for line in f: if '{SUB_URLS}' in line: new_lines.extend(formatted_urls) elif 'show-useless-url' in line: continue else: new_lines.append(line) with open(output_path, 'w', encoding='utf-8') as f: f.writelines(new_lines) " # C. åå°å¯åŠ¨å®¹å™¨ (ä½¿ç”¨ -d) docker run -d --name checker \ -v ${{ github.workspace }}/temp_config:/app/config \ -v ${{ github.workspace }}/output:/app/output \ -v ${{ github.workspace }}/output:/app/data \ -p 8299:8299 ghcr.io/aa2283/subs-check:master echo "ğŸš€ å®¹å™¨å·²åå°å¯åŠ¨ï¼Œå¼€å§‹å®æ—¶è¾“å‡ºæ£€æµ‹è¿›åº¦ï¼š" # å®æ—¶å¼•æµæ—¥å¿—åˆ°æ§åˆ¶å°ï¼Œè§£å†³â€œä¸è§æ£€æµ‹â€çš„é—®é¢˜ docker logs -f checker & # D. å“¨å…µé€»è¾‘ï¼šç›‘å¬ä¿å­˜æˆåŠŸä¿¡å· ( echo ">>> [å“¨å…µ] æ­£åœ¨è§‚å¯Ÿè¿›åº¦..." while true; do sleep 15 if ! docker ps | grep -q 'checker'; then break; fi LOGS=$(docker logs --tail 20 checker 2>&1 | sed 's/\x1b\[[0-9;]*m//g') if echo "$LOGS" | grep -qE "ä¿å­˜æœ¬åœ°æˆåŠŸ|èŠ‚ç‚¹ä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜"; then echo "âœ… [å“¨å…µæŠ¥å‘Š] å­˜ç›˜ä¿¡å·å·²ç¡®è®¤ã€‚" break fi done ) & - name: 3. å¼€å¯éš§é“å¹¶åŠ¨æ€æå–åŸŸå run: | # 1. ä¸‹è½½ cloudflared curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared chmod +x cloudflared # 2. å…ˆåˆ›å»ºæ—¥å¿—æ–‡ä»¶ï¼Œé˜²æ­¢ grep æŠ¥é”™ (è§£å†³ No such file æŠ¥é”™) touch backend.log # 3. å¯åŠ¨éš§é“ nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile backend.log > /dev/null 2>&1 & echo "ğŸ”„ æ­£åœ¨æå–éš§é“åŸŸå..." API_URL="" # å¾ªç¯ 20 æ¬¡ç­‰å¾…åŸŸååˆ†é… for i in {1..20}; do # åªæœ‰å½“æ–‡ä»¶é‡Œæœ‰åŸŸåæ—¶æ‰æå– if grep -q 'https://' backend.log 2>/dev/null; then API_URL=$(grep -o 'https://[-0-9a-z]*\.trycloudflare\.com' backend.log | tail -n 1) if [ -n "$API_URL" ]; then echo "::add-mask::$API_URL" echo "FINAL_API_URL=$API_URL" >> $GITHUB_ENV echo "âœ… æˆåŠŸæå–åŸŸå: $API_URL" break fi fi sleep 3 done if [ -z "$API_URL" ]; then echo "âŒ æå–å¤±è´¥ï¼Œbackend.log å†…å®¹å¦‚ä¸‹ï¼š" cat backend.log exit 1 fi - name: 4. æ£€å‡ºç§å¯†ä»“åº“å¹¶æ‰§è¡Œç²¾å‡†ä¸‹è½½åŒæ­¥ env: MY_TOKEN: ${{ secrets.PAT_TOKEN }} run: | # æ£€å‡ºç›®æ ‡ä»“åº“åˆ° target-repo ç›®å½• rm -rf target-repo git clone https://${{ secrets.PAT_TOKEN }}@github.com/aa2283/v2ray_configs.git target-repo mkdir -p subs for i in {1..15} do echo ">>> ç¬¬ $i/15 æ¬¡æ£€æŸ¥æ›´æ–° (8299 ç«¯å£)..." # ä½¿ç”¨ä½ çš„ curl ä¸‹è½½é€»è¾‘ if curl -s --connect-timeout 10 "http://127.0.0.1:8299/download/sub?target=ClashMeta" -o subs/new_clash.yaml; then if grep -q "proxies" subs/new_clash.yaml; then echo "ğŸ“¢ æŠ“å–æˆåŠŸï¼Œæ­£åœ¨æ¨é€åˆ° v2ray_configs..." mkdir -p target-repo/sub cp -f subs/new_clash.yaml target-repo/sub/all.yaml cd target-repo git config --local user.email "actions@github.com" git config --local user.name "GitHub Action" git add . git commit -m "è‡ªåŠ¨æ›´æ–°: $(date +'%H:%M:%S')" || echo "æ— å˜åŠ¨" git push cd .. echo "ğŸš€ åŒæ­¥å®Œæˆï¼" fi fi sleep 60 done - name: 5. å–„åæ¸…ç† if: always() run: | docker rm -f checker || true pkill cloudflared || true
