name: Subs-Check & Sub-Store ç»ˆæç¼åˆä¿®å¤ç‰ˆ

on:
  schedule:
    - cron: '15 4 * * *'
  workflow_dispatch:

jobs:
  check-subscriptions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: 1. æ£€å‡ºä¸»ä»“åº“
        uses: actions/checkout@v4

      - name: 2. è¿è¡Œæ£€æµ‹å™¨ (åå°å¸¸é©»æ¨¡å¼)
        run: |
          mkdir -p output temp_config sub-store-data
          chmod -R 777 output
          echo "output/" >> .gitignore
          echo "*.log" >> .gitignore
          
          # Python æ³¨å…¥é€»è¾‘
          export RAW_URLS_DATA="${{ secrets.SUB_URLS }}"
          python3 -c "
          import os
          template_path = 'config/config.yaml'
          output_path = 'temp_config/config.yaml'
          raw_urls = os.environ.get('RAW_URLS_DATA', '').strip().split('\n')
          formatted_urls = [f'  - \"{u.strip()}\"\n' for u in raw_urls if len(u.strip()) > 10]
          new_lines = ['show-useless-url: true\n']
          if os.path.exists(template_path):
              with open(template_path, 'r', encoding='utf-8') as f:
                  for line in f:
                      if '{SUB_URLS}' in line: new_lines.extend(formatted_urls)
                      elif 'show-useless-url' in line: continue
                      else: new_lines.append(line)
          with open(output_path, 'w', encoding='utf-8') as f:
              f.writelines(new_lines)
          "

          # å¯åŠ¨å®¹å™¨ï¼šåˆ†é… 4GB å†…å­˜åº”å¯¹ 9000 èŠ‚ç‚¹
          docker run -d --name checker \
            -e NODE_OPTIONS="--max-old-space-size=4096" \
            -v ${{ github.workspace }}/temp_config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            -p 8299:8299 ghcr.io/aa2283/subs-check:master

          # åå°å¼•æµæ—¥å¿—
          docker logs -f checker &

      - name: 3. æ£€å‡ºç›®æ ‡ä»“åº“ (v2ray_configs)
        uses: actions/checkout@v4
        with:
          repository: aa2283/v2ray_configs
          token: ${{ secrets.PAT_TOKEN }}
          path: target-repo-sync

      - name: 4. å¼€å¯éš§é“å¹¶åŠ¨æ€è„±æ•
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          # å¯åŠ¨éš§é“å¹¶ä¿æŒé™é»˜
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile backend.log > /dev/null 2>&1 &
          
          echo "ç­‰å¾…åŸŸåç”Ÿæˆ..."
          for i in {1..20}; do
            API_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' backend.log 2>/dev/null | head -n 1)
            if [ -n "$API_URL" ]; then
              # ã€æ ¸å¿ƒå®‰å…¨æ“ä½œã€‘å¯¹åŸŸåè¿›è¡Œè„±æ•å¤„ç†ï¼Œæ—¥å¿—ä¸­å°†æ˜¾ç¤ºä¸º ***
              echo "::add-mask::$API_URL"
              echo "FINAL_API_URL=$API_URL" >> $GITHUB_ENV
              echo "âœ… éš§é“å·²å»ºç«‹å¹¶å·²åŠ å¯†è„±æ•"
              break
            fi
            sleep 3
          done

      - name: 5. å‡†å¤‡ç›®æ ‡ä»“åº“ (é™é»˜æ¨¡å¼)
        env:
          MY_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # æå‰é¢„è®¾è¿œç¨‹åœ°å€ï¼Œé˜²æ­¢åé¢ push æ—¶æ—¥å¿—è¾“å‡ºå¸¦ Token çš„ URL
          git clone https://x-access-token:${{ secrets.MY_TOKEN }}@github.com/aa2283/v2ray_configs.git target-repo-sync >/dev/null 2>&1
          cd target-repo-sync
          git remote set-url origin "https://x-access-token:${{ secrets.MY_TOKEN }}@github.com/aa2283/v2ray_configs.git"
          echo "âœ… ç›®æ ‡ä»“åº“å·²å°±ç»ªï¼Œåœ°å€å·²è„±æ•"
          cd ..

      - name: 6. ä¸æ»‘å®æ—¶æ”¶å‰²ä¸ 15 åˆ†é’Ÿå€’è®¡æ—¶
        env:
          MY_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          set +x
          # 1. åŸºç¡€é…ç½®è„±æ•
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Action"
          git remote set-url origin "https://x-access-token:${MY_TOKEN}@github.com/${{ github.repository }}.git"

          echo "ğŸš€ å¯åŠ¨å®æ—¶æ£€æµ‹æµ (æ•è·å…³é”®å­—å°†è‡ªåŠ¨åŒæ­¥)..."
          echo "------------------------------------------------"

          # 2. æ ¸å¿ƒï¼šå¼€å¯åå°å®æ—¶æ—¥å¿—æµï¼ŒåŒæ—¶ç›‘æ§å…³é”®å­—
          # ä½¿ç”¨ç®¡é“é…åˆ read å®ç°æœ€ä¸æ»‘çš„æ—¥å¿—æ»šåŠ¨
          (
            docker logs -f checker 2>&1 | while read line; do
              # å®æ—¶æ‰“å°æ¯ä¸€è¡Œæ£€æµ‹æ—¥å¿—
              echo "$line" | grep -viE "token|secret|key"
              
              # ä¸€æ—¦å‘ç°å…³é”®å­—ï¼Œç«‹åˆ»å‘å‡ºä¿¡å·å¹¶ç»“æŸæ—¥å¿—æµ
              if echo "$line" | grep -q "ä¿å­˜æœ¬åœ°æˆåŠŸ"; then
                touch .success_signal
                break
              fi
            done
          ) &

          # 3. ä¸»è¿›ç¨‹ï¼šæ¯«ç§’çº§è½®è¯¢ä¿¡å·æ–‡ä»¶
          while true; do
            if [ -f ".success_signal" ]; then
              echo -e "\nğŸ¯ [ç³»ç»Ÿé€šçŸ¥] æ•è·æˆåŠŸï¼æ­£åœ¨ä¸æ»‘åŒæ­¥æ•°æ®..."
              
              sudo chmod -R 755 output/ 2>/dev/null || true
              COUNT=$(grep -c "name:" output/all.yaml || echo "0")

              # é™é»˜æ‰§è¡Œ Git æ“ä½œï¼Œå½»åº•æœç»â€œå°¾å·´â€
              cp -f output/all.yaml ./all.yaml
              git add all.yaml
              git commit -m "Auto Update: $COUNT nodes" >/dev/null 2>&1 || true
              git pull --rebase origin main >/dev/null 2>&1
              git push origin main >/dev/null 2>&1

              if [ -d "target-repo-sync" ]; then
                cd target-repo-sync
                # å†æ¬¡ç¡®è®¤ç›®æ ‡åº“åœ°å€å·²éšè—
                git remote set-url origin "https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/aa2283/v2ray_configs.git"
                mkdir -p subs && cp -f ../output/all.yaml ./subs/all.yaml
                git add .
                git commit -m "Sync: $COUNT" >/dev/null 2>&1 || true
                git pull --rebase origin main >/dev/null 2>&1
                git push origin main >/dev/null 2>&1
                cd ..
              fi

              echo "âœ… åŒæ­¥åœ†æ»¡å®Œæˆã€‚åœæ­¢æ£€æµ‹å™¨..."
              docker stop checker >/dev/null 2>&1

              echo "------------------------------------------------"
              echo "â° éš§é“å·²é”å®šï¼Œæ‚¨æœ‰ 15 åˆ†é’Ÿæ—¶é—´æ“ä½œç½‘é¡µ..."
              for j in {15..1}; do
                echo "â³ å‰©ä½™æ—¶é—´: $j åˆ†é’Ÿ..."
                sleep 60
              done
              
              echo "ğŸ”” ä»»åŠ¡é¡ºåˆ©ç»“æŸã€‚"
              exit 0
            fi
            
            # æ£€æŸ¥åå°è¿›ç¨‹æ˜¯å¦è¿˜åœ¨ï¼ˆé˜²æ­¢æ„å¤–å´©æºƒï¼‰
            if ! kill -0 $! 2>/dev/null && [ ! -f ".success_signal" ]; then
              echo "âŒ ç›‘æ§è¿›ç¨‹å¼‚å¸¸é€€å‡º"
              exit 1
            fi
            
            sleep 2 # æ¯ 2 ç§’æ‰«æä¸€æ¬¡ä¿¡å·ï¼Œå“åº”æå¿«
          done
            fi
            sleep 10
          done
          done
