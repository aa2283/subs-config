name: Sub-Store Fixed Integration
on:
  workflow_dispatch:

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. å‡†å¤‡å®¿ä¸»æœºç¯å¢ƒ
        run: |
          # åˆ›å»ºé…ç½®ç›®å½•
          mkdir -p ${{ github.workspace }}/temp_config
          mkdir -p ${{ github.workspace }}/output
          
          # ç›´æ¥åœ¨å®¿ä¸»æœºç”Ÿæˆâ€œå®Œç¾â€é…ç½®æ–‡ä»¶
          # ç¡®ä¿ç«¯å£å’Œé¢æ¿å¼€å…³å…¨éƒ¨æ­£ç¡®
          cat <<EOF > ${{ github.workspace }}/temp_config/config.yaml
          server:
            port: 8199
            addr: 0.0.0.0
            web-control: true
          EOF
          
          # ç»™äºˆæœ€é«˜æƒé™ï¼Œç¡®ä¿ Docker é‡Œçš„ç¨‹åºèƒ½è¯»åˆ°å®ƒ
          sudo chmod -R 777 ${{ github.workspace }}/temp_config
          sudo chmod -R 777 ${{ github.workspace }}/output
          echo "âœ… å®¿ä¸»æœºé…ç½®å‡†å¤‡å®Œæ¯•"

      - name: 2. å¼ºåŠ›å¯åŠ¨å®¹å™¨
        run: |
          echo "ğŸš€ æŒ‚è½½é…ç½®å¹¶å¯åŠ¨å®¹å™¨..."
          # å°†å‡†å¤‡å¥½çš„ config.yaml æŒ‚è½½åˆ°å®¹å™¨æœŸæœ›çš„ä¸¤ä¸ªå¯èƒ½è·¯å¾„
          # åŒæ—¶æ˜ å°„ 8199 å’Œ 8299
          docker run --name checker -d \
            -p 8199:8199 -p 8299:8299 \
            -v ${{ github.workspace }}/temp_config/config.yaml:/app/config/config.yaml \
            -v ${{ github.workspace }}/temp_config/config.yaml:/app/config.yaml \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master

          # ç»™ç¨‹åºä¸€ç‚¹æ—¶é—´è¯»å–æ–‡ä»¶
          sleep 15

          # å¦‚æœè¿˜æ˜¯é€€å‡ºäº†ï¼Œæ‰“å°æœ€åæŠ¥é”™æ—¥å¿—
          echo "ğŸ“‹ å®¹å™¨è¿è¡ŒçŠ¶æ€æŸ¥çœ‹ï¼š"
          docker ps -a
          echo "ğŸ“‹ å®¹å™¨æœ€åæ—¥å¿—å†…å®¹ï¼š"
          docker logs checker

      - name: 3. ç”³è¯·éš§é“
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          
          echo "ğŸŒ æ­£åœ¨å»ºç«‹ Cloudflare éš§é“..."
          nohup ./cloudflared tunnel --url http://127.0.0.1:8199 --logfile tunnel.log > /dev/null 2>&1 &
          
          sleep 15
          URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)

          echo "------------------------------------------------"
          if [ -n "$URL" ]; then
            echo "âœ… è®¿é—®åœ°å€: $URL/admin"
          else
            echo "âŒ éš§é“ç”³è¯·å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šæ–¹å®¹å™¨æ—¥å¿—"
          fi
          echo "------------------------------------------------"

          for i in {15..1}; do
            echo "â³ éš§é“æœ‰æ•ˆæ—¶é—´å‰©ä½™: $i åˆ†é’Ÿ..."
            sleep 60
          done
