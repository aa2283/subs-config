name: Sub-Store Integration Check & Sync 23
on:
  workflow_dispatch:

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 2. å‡†å¤‡ç›®å½•ä¸ Git ç¯å¢ƒ
        env:
          MY_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          mkdir -p output temp_config
          # é™é»˜å‡†å¤‡ç§æœ‰åº“ï¼Œç”¨äºåç»­åŒè·¯åŒæ­¥
          git clone --quiet "https://x-access-token:${MY_TOKEN}@github.com/aa2283/v2ray_configs.git" target-repo-sync || true
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Action"
          echo "âœ… åŸºç¡€ç¯å¢ƒå‡†å¤‡å°±ç»ª"

      - name: 3. å¼ºåŠ›å¯åŠ¨æœåŠ¡ (å®Œæ•´é…ç½®ç‰ˆ)
        run: |
          mkdir -p ${{ github.workspace }}/temp_config
          mkdir -p ${{ github.workspace }}/output
          
          # ã€å…³é”®ã€‘é¢„ç½®æ­£ç¡®çš„ config.yaml å¼€å¯ Web é¢æ¿
          cat <<EOF > ${{ github.workspace }}/temp_config/config.yaml
          server:
            port: 8199
            addr: 0.0.0.0
            web-control: true  # æ˜¾å¼å¼€å¯é¢æ¿
          # è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ ä½ çš„è®¢é˜…é“¾æ¥ï¼Œæˆ–è€…ç©ºç€å»ç½‘é¡µç«¯å¡«
          EOF

          sudo chmod -R 777 ${{ github.workspace }}/temp_config
          sudo chmod -R 777 ${{ github.workspace }}/output

          echo "ğŸš€ å¯åŠ¨é›†æˆå®¹å™¨..."
          docker run --name checker -d \
            --network host \
            -v ${{ github.workspace }}/temp_config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master

          sleep 10

      - name: 4. å¼€å¯éš§é“ä¸å“¨å…µæ”¶å‰²é€»è¾‘
        env:
          MY_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          set +x
          # å»ºç«‹éš§é“æŒ‡å‘ 8199
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://localhost:8199 --logfile tunnel.log > /dev/null 2>&1 &
          
          sleep 10
          TUNNEL_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
          echo "------------------------------------------------"
          echo "ğŸŒ Sub-Store è®¿é—®åœ°å€: $TUNNEL_URL/admin"
          echo "------------------------------------------------"

          # ã€åå°å“¨å…µã€‘å®æ—¶æ”¶å‰²
          (
            while true; do
              sleep 15
              if ! docker ps | grep -q 'checker'; then break; fi
              
              LOGS=$(docker logs --tail 20 checker 2>&1 | sed 's/\x1b\[[0-9;]*m//g')
              # åŒ¹é…ä½ æ—¥å¿—ä¸­å‡ºç°çš„å…³é”®å­—
              if echo "$LOGS" | grep -qE "ä¿å­˜æœ¬åœ°æˆåŠŸ|å­˜ç›˜æˆåŠŸ|æ£€æµ‹å®Œæˆ"; then
                echo "ğŸ¯ [å“¨å…µ] æ•è·å­˜ç›˜æˆ–æ£€æµ‹å®Œæˆä¿¡å·ï¼Œå¼€å§‹åŒæ­¥..."
                
                sudo chmod -R 755 output/ 2>/dev/null || true
                [ -f "output/all.yaml" ] || continue # å¦‚æœæ–‡ä»¶è¿˜æ²¡ç”Ÿæˆåˆ™è·³è¿‡è¿™æ¬¡
                
                COUNT=$(grep -c "name:" output/all.yaml 2>/dev/null || echo "0")
                
                # é™é»˜åŒæ­¥
                cp -f output/all.yaml ./all.yaml 2>/dev/null || true
                git add all.yaml
                git commit -m "Auto Sync: $COUNT nodes" >/dev/null 2>&1 || true
                git push --quiet "https://x-access-token:${MY_TOKEN}@github.com/${{ github.repository }}.git" HEAD:main >/dev/null 2>&1
                
                if [ -d "target-repo-sync" ]; then
                  cd target-repo-sync
                  mkdir -p subs && cp -f ../output/all.yaml ./subs/all.yaml 2>/dev/null || true
                  git add .
                  git commit -m "Sync: $COUNT" >/dev/null 2>&1 || true
                  git push --quiet "https://x-access-token:${MY_TOKEN}@github.com/aa2283/v2ray_configs.git" HEAD:main >/dev/null 2>&1
                  cd ..
                fi
                echo "âœ… åŒæ­¥åœ†æ»¡å®Œæˆã€‚"
              fi
            done
          ) &

          # æŒ‚æœºå€’è®¡æ—¶
          for i in {15..1}; do
            echo "â³ å­˜æ´»å€’è®¡æ—¶: $i åˆ†é’Ÿ..."
            sleep 60
          done

      - name: 5. å¼€å¯åŒéš§é“ä¸è‡ªåŠ¨æ”¶å‰²å“¨å…µ
        env:
          MY_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          set +x
          # å®‰è£… cloudflared
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          
          echo "ğŸŒ æ­£åœ¨å»ºç«‹ Cloudflare éš§é“..."
          nohup ./cloudflared tunnel --url http://localhost:8299 --logfile tunnel_8299.log > /dev/null 2>&1 &
          nohup ./cloudflared tunnel --url http://localhost:8199 --logfile tunnel_8199.log > /dev/null 2>&1 &
          
          sleep 12
          URL_8299=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel_8299.log | head -n 1)
          URL_8199=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel_8199.log | head -n 1)

          echo "------------------------------------------------"
          echo "ğŸ”— åç«¯æ¥å£ (8299): $URL_8299"
          echo "ğŸ”— å‰ç«¯ç•Œé¢ (8199): $URL_8199/admin"
          echo "------------------------------------------------"
          echo "ğŸ’¡ æç¤ºï¼šåœ¨ç½‘é¡µç«¯ç‚¹æ£€æµ‹ä¿å­˜ï¼Œè„šæœ¬å°†è‡ªåŠ¨æ„Ÿåº”å¹¶åŒæ­¥ä»“åº“ã€‚"

          # ã€åå°å“¨å…µã€‘å®æ—¶ç›‘å¬æ—¥å¿—ï¼Œä¸€æ—¦å‘ç°ä¿å­˜åŠ¨ä½œï¼Œç«‹å³åŒæ­¥
          # ã€åå°å“¨å…µã€‘å®æ—¶æ”¶å‰² (å¸¦é˜²é‡å¤è§¦å‘æœºåˆ¶)
          (
            echo "ğŸ¹ å“¨å…µå·²è¿›å…¥æ½œä¼çŠ¶æ€ï¼Œç›‘æ§æ—¥å¿—æµ..."
            LAST_SYNC_MARK="" # è®°å½•ä¸Šä¸€æ¬¡åŒæ­¥æ—¶çš„æœ€åä¸€è¡Œæ—¥å¿—
            
            while true; do
              sleep 20
              if ! docker ps | grep -q 'checker'; then break; fi
              
              # è·å–æœ€æ–°çš„æ—¥å¿—ç‰¹å¾ï¼ˆå–æœ€å 1 è¡Œæ£€æµ‹å®Œæˆç›¸å…³çš„æ—¥å¿—ï¼‰
              CURRENT_SYNC_MARK=$(docker logs checker 2>&1 | grep -E "ä¿å­˜æœ¬åœ°æˆåŠŸ|å­˜ç›˜æˆåŠŸ|æ£€æµ‹å®Œæˆ" | tail -n 1)
              
              # å¦‚æœå½“å‰æ ‡è®°ä¸ä¸ºç©ºï¼Œä¸”ä¸ä¸Šæ¬¡æ ‡è®°ä¸åŒï¼Œåˆ™æ‰§è¡ŒåŒæ­¥
              if [ -n "$CURRENT_SYNC_MARK" ] && [ "$CURRENT_SYNC_MARK" != "$LAST_SYNC_MARK" ]; then
                echo -e "\nğŸ¯ [å“¨å…µ] æ•è·åˆ°æ–°çš„å­˜ç›˜ä¿¡å·ï¼Œå¼€å§‹åŒæ­¥..."
                
                sudo chmod -R 755 output/ 2>/dev/null || true
                
                # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
                if [ -s "output/all.yaml" ]; then
                  COUNT=$(grep -c "name:" output/all.yaml 2>/dev/null || echo "0")
                  
                  # é™é»˜åŒæ­¥
                  cp -f output/all.yaml ./all.yaml 2>/dev/null || true
                  git add all.yaml
                  git commit -m "Auto Sync: $COUNT nodes" >/dev/null 2>&1 || true
                  git push --quiet "https://x-access-token:${MY_TOKEN}@github.com/${{ github.repository }}.git" HEAD:main >/dev/null 2>&1
                  
                  if [ -d "target-repo-sync" ]; then
                    cd target-repo-sync
                    mkdir -p subs && cp -f ../output/all.yaml ./subs/all.yaml 2>/dev/null || true
                    git add .
                    git commit -m "Sync: $COUNT" >/dev/null 2>&1 || true
                    git push --quiet "https://x-access-token:${MY_TOKEN}@github.com/aa2283/v2ray_configs.git" HEAD:main >/dev/null 2>&1
                    cd ..
                  fi
                  echo "âœ… [ç³»ç»Ÿ] åŒæ­¥åœ†æ»¡å®Œæˆï¼Œæ ‡è®°å½“å‰çŠ¶æ€é˜²æ­¢é‡å¤ã€‚"
                  LAST_SYNC_MARK="$CURRENT_SYNC_MARK" # æ›´æ–°æ ‡è®°ï¼Œè¿›å…¥å†·å´
                else
                  echo "âš ï¸ [å“¨å…µ] è™½æœ‰ä¿¡å·ä½† output/all.yaml ä¸ºç©ºï¼Œè·³è¿‡åŒæ­¥ã€‚"
                  LAST_SYNC_MARK="$CURRENT_SYNC_MARK" # å³ä½¿ä¸ºç©ºä¹Ÿæ›´æ–°æ ‡è®°ï¼Œé¿å…æ­»å¾ªç¯
                fi
              fi
            done
          ) &
                
                # A. åŒæ­¥ä¸»ä»“åº“ (ä¸æ³„éœ² Token)
                cp -f output/all.yaml ./all.yaml 2>/dev/null || true
                git add all.yaml
                git commit -m "Auto Update: $COUNT nodes" >/dev/null 2>&1 || true
                git push --quiet "https://x-access-token:${MY_TOKEN}@github.com/${{ github.repository }}.git" HEAD:main >/dev/null 2>&1

                # B. åŒæ­¥ç§æœ‰ä»“åº“
                if [ -d "target-repo-sync" ]; then
                  cd target-repo-sync
                  mkdir -p subs && cp -f ../output/all.yaml ./subs/all.yaml 2>/dev/null || true
                  git add .
                  git commit -m "Web Sync: $COUNT" >/dev/null 2>&1 || true
                  git push --quiet "https://x-access-token:${MY_TOKEN}@github.com/aa2283/v2ray_configs.git" HEAD:main >/dev/null 2>&1
                  cd ..
                fi
                echo "âœ… [ç³»ç»Ÿ] ä»“åº“å·²æˆåŠŸåŒæ­¥æœ€æ–°èŠ‚ç‚¹ã€‚"
              fi
            done
          ) &

          # 6. æŒ‚æœºä¿ç•™æ¨¡å¼ (15åˆ†é’Ÿ)
          for i in {15..1}; do
            echo "â³ éš§é“å­˜æ´»å€’è®¡æ—¶: $i åˆ†é’Ÿ..."
            sleep 60
          done
          echo "ğŸ”” ä»»åŠ¡ç»“æŸï¼Œæ­£åœ¨æ¸…ç†èµ„æºã€‚"
