name: Sub-Store Integration Final
on:
  workflow_dispatch:

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. å‡†å¤‡ä¸æ£€æŸ¥è·¯å¾„
        run: |
          # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output
          
          # æ£€æŸ¥ä½ çš„ä»“åº“æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "${{ github.workspace }}/config/config.yaml" ]; then
            echo "âœ… å‘ç°ä»“åº“é…ç½®æ–‡ä»¶: ${{ github.workspace }}/config/config.yaml"
            # å¼ºè¡Œç»™ä»“åº“é‡Œçš„é…ç½®æ–‡ä»¶åŠ æƒï¼Œé˜²æ­¢å®¹å™¨è¯»ä¸åˆ°
            sudo chmod 644 ${{ github.workspace }}/config/config.yaml
          else
            echo "âŒ é”™è¯¯ï¼šä»“åº“ä¸­æœªæ‰¾åˆ° config/config.yaml"
            exit 1
          fi

      - name: 3. å¯åŠ¨å®¹å™¨ (ç²¾ç¡®æŒ‚è½½ä»“åº“æ–‡ä»¶)
        run: |
          echo "ğŸš€ æ­£åœ¨å¯åŠ¨å®¹å™¨ï¼ŒæŒ‚è½½ä»“åº“é…ç½®..."
          # å°†ä½ ä»“åº“çš„ config/config.yaml æŒ‚è½½åˆ°å®¹å™¨å†…ç¨‹åºå¯»æ‰¾çš„ä½ç½®
          # æˆ‘ä»¬åŒæ—¶æŒ‚è½½åˆ° /app/config/ å’Œ /app/ ä»¥é˜²ä¸‡ä¸€
          docker run --name checker -d \
            -p 8199:8199 -p 8299:8299 \
            -v ${{ github.workspace }}/config/config.yaml:/app/config/config.yaml \
            -v ${{ github.workspace }}/config/config.yaml:/app/config.yaml \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master
          
          sleep 15
          echo "ğŸ“‹ å®¹å™¨å¯åŠ¨æ—¥å¿—è¯Šæ–­ï¼š"
          docker logs checker

      - name: 4. å»ºç«‹åŒè·¯éš§é“
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          
          # ç”³è¯·éš§é“
          nohup ./cloudflared tunnel --url http://127.0.0.1:8199 --logfile tunnel_8199.log > /dev/null 2>&1 &
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel_8299.log > /dev/null 2>&1 &
          
          sleep 15
          URL_8199=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel_8199.log | head -n 1)
          URL_8299=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel_8299.log | head -n 1)

          echo "------------------------------------------------"
          echo "âœ… é…ç½®å·²æŒ‚è½½ï¼è¯·è®¿é—®ï¼š"
          echo "ğŸŒ ç«¯å£ 8199 (é¢æ¿): $URL_8199/admin"
          echo "ğŸŒ ç«¯å£ 8299 (æ ¸å¿ƒ): $URL_8299"
          echo "------------------------------------------------"

      - name: 5. å“¨å…µè‡ªåŠ¨åŒæ­¥
        env:
          MY_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          (
            LAST_MARK=""
            while true; do
              sleep 20
              if ! docker ps | grep -q 'checker'; then break; fi
              CUR_MARK=$(docker logs checker 2>&1 | grep "æ£€æµ‹å®Œæˆ" | tail -n 1)
              
              if [ -n "$CUR_MARK" ] && [ "$CUR_MARK" != "$LAST_MARK" ]; then
                echo "ğŸ¯ æ•è·å­˜ç›˜ä¿¡å·ï¼ŒåŒæ­¥ä¸­..."
                LAST_MARK="$CUR_MARK"
                if [ -s "output/all.yaml" ]; then
                  cp -f output/all.yaml ./all.yaml
                  git config --global user.email "action@github.com"
                  git config --global user.name "GitHub Action"
                  git add all.yaml
                  git commit -m "Auto Update Nodes" || true
                  git push --quiet "https://x-access-token:${MY_TOKEN}@github.com/${{ github.repository }}.git" HEAD:main
                  echo "âœ… ä»“åº“åŒæ­¥åœ†æ»¡å®Œæˆ"
                fi
              fi
            done
          ) &
          
          for i in {15..1}; do
            echo "â³ å­˜æ´»å€’è®¡æ—¶: $i åˆ†é’Ÿ..."
            sleep 60
          done
