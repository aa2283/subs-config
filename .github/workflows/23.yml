name: Sub-Store Multi-Tunnel Service
on:
  workflow_dispatch:

jobs:
  launch:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: 2. å½»åº•åˆå§‹åŒ–é…ç½® (å¼ºåˆ¶å¼€å¯ Web)
        run: |
          mkdir -p ${{ github.workspace }}/temp_config
          mkdir -p ${{ github.workspace }}/output
          
          # åˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œç¡®ä¿ web-control ä¸º true
          cat <<EOF > ${{ github.workspace }}/temp_config/config.yaml
          server:
            port: 8199
            addr: 0.0.0.0
            web-control: true
          EOF
          
          sudo chmod -R 777 ${{ github.workspace }}/temp_config
          sudo chmod -R 777 ${{ github.workspace }}/output

      - name: 3. å¯åŠ¨å®¹å™¨ (å¸¦ç¯å¢ƒå˜é‡åŒé‡ä¿é™©)
        run: |
          # æœ‰äº›é•œåƒæ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡å¼€å¯ Webï¼Œè¿™é‡ŒåŠ ä¸Šä½œä¸ºåŒé‡ä¿é™©
          docker run --name checker -d \
            --network host \
            -e "SUB_STORE_FRONTEND=true" \
            -e "WEB_CONTROL=true" \
            -v ${{ github.workspace }}/temp_config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master
          
          echo "â³ ç­‰å¾…æœåŠ¡å®Œå…¨é¢„çƒ­..."
          sleep 15
          docker logs checker | grep "Webæ§åˆ¶é¢æ¿" || echo "âš ï¸ è­¦å‘Šï¼šæ—¥å¿—ä¸­æœªå‘ç°é¢æ¿å¯åŠ¨å­—æ ·"

      - name: 4. ç”³è¯·éš§é“å¹¶æ•æ‰ 404 æ•…éšœ
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          
          echo "ğŸŒ æ­£åœ¨å»ºç«‹åŒç«¯å£æ˜ å°„..."
          nohup ./cloudflared tunnel --url http://127.0.0.1:8199 --logfile tunnel_8199.log > /dev/null 2>&1 &
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel_8299.log > /dev/null 2>&1 &
          
          sleep 15
          URL_A=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel_8199.log | head -n 1)
          URL_B=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel_8299.log | head -n 1)

          echo "------------------------------------------------"
          if [ -n "$URL_A" ]; then
            echo "ğŸš€ æ–¹æ¡ˆ A (8199):"
            echo "å°è¯• 1 (æœ€æ¨è): $URL_A/admin"
            echo "å°è¯• 2 (æ ¹è·¯å¾„): $URL_A/"
          fi
          echo "----------------"
          if [ -n "$URL_B" ]; then
            echo "ğŸš€ æ–¹æ¡ˆ B (8299):"
            echo "å°è¯• 1 (æœ€æ¨è): $URL_B/admin"
            echo "å°è¯• 2 (æ ¹è·¯å¾„): $URL_B/"
          fi
          echo "------------------------------------------------"
          
          # æŒ‚æœºä¿æ´»
          for i in {15..1}; do
            echo "â³ å­˜æ´»å€’è®¡æ—¶: $i åˆ†é’Ÿ (å¦‚é‡ 404 è¯·æ£€æŸ¥ URL ç»“å°¾æ˜¯å¦å¸¦ /admin)"
            sleep 60
          done
