name: Graphic Management & Auto Sync 23
on:
  workflow_dispatch:

jobs:
  run-graphic:
    runs-on: ubuntu-latest
    steps:
      - name: 1. ç¯å¢ƒä¸ Git é¢„è®¾
        uses: actions/checkout@v4

      - name: 2. å‡†å¤‡ç›®å½•ä¸ç§æœ‰åº“
        env:
          MY_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          mkdir -p output temp_config
          git clone --quiet "https://x-access-token:${MY_TOKEN}@github.com/aa2283/v2ray_configs.git" target-repo-sync || true
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Action"

      - name: 3. å¼ºåˆ¶å¯åŠ¨æœåŠ¡å¹¶è‡ªåŠ¨æ¢æµ‹ç«¯å£
        run: |
          # 1. å°è¯•æ˜¾å¼å¯åŠ¨ sub-store æœåŠ¡ï¼ˆå¦‚æœæ˜¯è¯¥é•œåƒéœ€è¦æ‰‹åŠ¨å¯åŠ¨çš„è¯ï¼‰
          # æˆ‘ä»¬åœ¨åå°è¿è¡Œå®ƒï¼Œç¡®ä¿å®ƒä¸ä¼šé˜»å¡è„šæœ¬
          docker run --name checker -d \
            --network host \
            -v ${{ github.workspace }}/temp_config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            -p 8299:8299 -p 8199:8199 ghcr.io/aa2283/subs-check:master

            

          echo "ğŸ” æ­£åœ¨æ‰«æå®¹å™¨å®é™…ç›‘å¬çš„ç«¯å£..."
          sleep 15

          # 1. å¼ºåˆ¶æ¿€æ´»åç«¯ API çŠ¶æ€
            timeout 60s bash -c 'until curl -s http://127.0.0.1:8299 > /dev/null; do sleep 2; done'
            curl -s -o /dev/null "https://sub-store.vercel.app/?api=http://127.0.0.1:8299"
            sleep 2
          
          # è‡ªåŠ¨è·å–å®¹å™¨æ­£åœ¨ç›‘å¬çš„ç«¯å£ (æ’é™¤æ‰å¸¸è§çš„ç³»ç»Ÿç«¯å£)
          REAL_PORT=$(sudo netstat -tunlp | grep -oP '(?<=0.0.0.0:)[0-9]+|(?<=:::)[0-9]+' | grep -vE '22|53|111' | head -n 1 || echo "8299")
          echo "ğŸ¯ æ¢æµ‹åˆ°æœåŠ¡å¯èƒ½è¿è¡Œåœ¨ç«¯å£: $REAL_PORT"
          echo "REAL_PORT=$REAL_PORT" >> $GITHUB_ENV

      - name: 4. å¼€å¯åŠ¨æ€éš§é“ä¸å“¨å…µæ”¶å‰²
        env:
          MY_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          PORT=${{ env.REAL_PORT }}
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          
          # å¼€å¯æŒ‡å‘æ¢æµ‹åˆ°çš„ç«¯å£çš„éš§é“
          nohup ./cloudflared tunnel --url http://127.0.0.1:$PORT --logfile tunnel.log > /dev/null 2>&1 &
          
          sleep 10
          TUNNEL_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
          echo "------------------------------------------------"
          echo "ğŸŒ Sub-Store è®¿é—®åœ°å€: $TUNNEL_URL"
          echo "------------------------------------------------"

          # å¯åŠ¨å“¨å…µï¼šç›‘æ§æ£€æµ‹æ˜¯å¦å®Œæˆ
          (
            while true; do
              sleep 15
              if ! docker ps | grep -q 'checker'; then break; fi
              
              # è¿™é‡Œçš„é€»è¾‘ï¼šåªè¦ä½ åœ¨ç½‘é¡µç‚¹äº†â€œæ£€æµ‹â€å¹¶äº§ç”Ÿäº†æ—¥å¿—ï¼Œæˆ–è€…æ£€æµ‹è‡ªåŠ¨å®Œæˆäº†
              LOGS=$(docker logs --tail 50 checker 2>&1 || echo "")
              if echo "$LOGS" | grep -qE "ä¿å­˜æœ¬åœ°æˆåŠŸ|å­˜ç›˜æˆåŠŸ|èŠ‚ç‚¹ä¸ºç©º"; then
                echo "ğŸ¯ [å“¨å…µ] æ•è·å­˜ç›˜ä¿¡å·ï¼Œå¼€å§‹æ¨é€ä»“åº“..."
                
                sudo chmod -R 755 output/ 2>/dev/null || true
                COUNT=$(grep -c "name:" output/all.yaml 2>/dev/null || echo "0")
                
                # é™é»˜åŒæ­¥
                git push --quiet "https://x-access-token:${MY_TOKEN}@github.com/${{ github.repository }}.git" --delete main:main 2>/dev/null || true
                cp -f output/all.yaml ./all.yaml 2>/dev/null || true
                git add all.yaml
                git commit -m "Web Sync: $COUNT nodes" >/dev/null 2>&1 || true
                git push --quiet "https://x-access-token:${MY_TOKEN}@github.com/${{ github.repository }}.git" HEAD:main >/dev/null 2>&1
                
                if [ -d "target-repo-sync" ]; then
                  cd target-repo-sync
                  mkdir -p subs && cp -f ../output/all.yaml ./subs/all.yaml 2>/dev/null || true
                  git add .
                  git commit -m "Sync: $COUNT" >/dev/null 2>&1 || true
                  git push --quiet "https://x-access-token:${MY_TOKEN}@github.com/aa2283/v2ray_configs.git" HEAD:main >/dev/null 2>&1
                  cd ..
                fi
                echo "âœ… åŒæ­¥å®Œæˆï¼"
              fi
            done
          ) &

          # æŒ‚æœºå€’è®¡æ—¶
          for i in {15..1}; do
            echo "â³ éš§é“å­˜æ´»ä¸­ (ç«¯å£ $PORT): $i åˆ†é’Ÿ..."
            sleep 60
          done
