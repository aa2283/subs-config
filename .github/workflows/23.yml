name: Sub-Store Integration Check & Sync 23
on:
  workflow_dispatch:

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 检出代码
        uses: actions/checkout@v4

      - name: 2. 准备目录与 Git 环境
        env:
          MY_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          mkdir -p output temp_config
          # 静默准备私有库，用于后续双路同步
          git clone --quiet "https://x-access-token:${MY_TOKEN}@github.com/aa2283/v2ray_configs.git" target-repo-sync || true
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Action"
          echo "✅ 基础环境准备就绪"

      - name: 3. 强力启动服务 (指定启动路径)
        run: |
          # 1. 赋予挂载目录最高权限，防止权限拒绝导致启动失败
          sudo chmod -R 777 ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/temp_config

          echo "🚀 启动集成容器..."
          # 放弃 --network host，改用显式端口映射，这样更易排查
          docker run --name checker -d \
            -p 8299:8299 -p 8199:8199 \
            -v ${{ github.workspace }}/temp_config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master

          # 2. 如果容器启动后秒退，这里会显示原因
          sleep 10
          echo "--- 容器当前状态 ---"
          docker ps -a
          
          echo "--- 容器实时日志 ---"
          docker logs checker || echo "无法获取日志"

      - name: 4. 再次检查端口 (带保底逻辑)
        run: |
          echo "🔍 扫描监听端口..."
          # 检查容器内部是否真的在运行服务
          for i in {1..15}; do
            if curl -s http://localhost:8299 > /dev/null || curl -s http://localhost:8199 > /dev/null; then
              echo "✅ 服务已上线！"
              exit 0
            fi
            echo "正在探测端口... ($i/15)"
            sleep 4
          done
          
          echo "❌ 依旧无法连接。尝试列出容器内进程："
          docker exec checker ps aux || echo "无法进入容器"
          exit 1

          echo "❌ 探测失败！输出所有诊断信息："
          echo "--- 容器状态 ---"
          docker ps -a
          echo "--- 容器实时日志 (关键) ---"
          docker logs checker
          echo "--- 宿主机端口占用情况 ---"
          sudo netstat -tunlp
          exit 1

      - name: 5. 开启双隧道与自动收割哨兵
        env:
          MY_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          set +x
          # 安装 cloudflared
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          
          echo "🌐 正在建立 Cloudflare 隧道..."
          nohup ./cloudflared tunnel --url http://localhost:8299 --logfile tunnel_8299.log > /dev/null 2>&1 &
          nohup ./cloudflared tunnel --url http://localhost:8199 --logfile tunnel_8199.log > /dev/null 2>&1 &
          
          sleep 12
          URL_8299=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel_8299.log | head -n 1)
          URL_8199=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel_8199.log | head -n 1)

          echo "------------------------------------------------"
          echo "🔗 后端接口 (8299): $URL_8299"
          echo "🔗 前端界面 (8199): $URL_8199/admin"
          echo "------------------------------------------------"
          echo "💡 提示：在网页端点检测保存，脚本将自动感应并同步仓库。"

          # 【后台哨兵】实时监听日志，一旦发现保存动作，立即同步
          (
            echo "🏹 哨兵已进入潜伏状态，监控日志流..."
            while true; do
              sleep 15
              if ! docker ps | grep -q 'checker'; then break; fi
              
              # 清洗日志颜色代码并抓取关键字
              LOGS=$(docker logs --tail 20 checker 2>&1 | sed 's/\x1b\[[0-9;]*m//g')
              
              if echo "$LOGS" | grep -qE "保存本地成功|存盘成功|节点为空"; then
                echo -e "\n🎯 [实时命中] 检测到存盘动作！触发静默同步..."
                
                sudo chmod -R 755 output/ 2>/dev/null || true
                COUNT=$(grep -c "name:" output/all.yaml 2>/dev/null || echo "0")
                
                # A. 同步主仓库 (不泄露 Token)
                cp -f output/all.yaml ./all.yaml 2>/dev/null || true
                git add all.yaml
                git commit -m "Auto Update: $COUNT nodes" >/dev/null 2>&1 || true
                git push --quiet "https://x-access-token:${MY_TOKEN}@github.com/${{ github.repository }}.git" HEAD:main >/dev/null 2>&1

                # B. 同步私有仓库
                if [ -d "target-repo-sync" ]; then
                  cd target-repo-sync
                  mkdir -p subs && cp -f ../output/all.yaml ./subs/all.yaml 2>/dev/null || true
                  git add .
                  git commit -m "Web Sync: $COUNT" >/dev/null 2>&1 || true
                  git push --quiet "https://x-access-token:${MY_TOKEN}@github.com/aa2283/v2ray_configs.git" HEAD:main >/dev/null 2>&1
                  cd ..
                fi
                echo "✅ [系统] 仓库已成功同步最新节点。"
              fi
            done
          ) &

          # 6. 挂机保留模式 (15分钟)
          for i in {15..1}; do
            echo "⏳ 隧道存活倒计时: $i 分钟..."
            sleep 60
          done
          echo "🔔 任务结束，正在清理资源。"
