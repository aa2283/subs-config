name: Sub-Store Ultimate Integration
on:
  workflow_dispatch:

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»£ç ä¸å‡†å¤‡ç¯å¢ƒ
        uses: actions/checkout@v4

      - name: 2. å¯åŠ¨å®¹å™¨ (åˆå§‹åŒ–)
        run: |
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output
          
          echo "ğŸš€ æ­£åœ¨å¯åŠ¨é•œåƒ..."
          # åŒæ—¶æ˜ å°„ 8199 å’Œ 8299ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±
          docker run --name checker -d \
            -p 8199:8199 \
            -p 8299:8299 \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master
          
          sleep 5

      - name: 3. æ¿€æ´»é…ç½®æ–‡ä»¶ (è§£å†³ 404/ç¦ç”¨é¢æ¿æ ¸å¿ƒæ­¥)
        run: |
          echo "ğŸ› ï¸ æ­£åœ¨å®¹å™¨å†…éƒ¨æ¿€æ´» config.yaml..."
          # é€»è¾‘ï¼šæŸ¥æ‰¾ example æ–‡ä»¶ï¼Œå¤åˆ¶ä¸ºæ­£å¼ç‰ˆï¼Œå¹¶å¼ºè¡Œå°† web-control è®¾ä¸º true
          docker exec checker sh -c "
            if [ -f '/app/config/config.example.yaml' ]; then
              cp /app/config/config.example.yaml /app/config/config.yaml
              echo 'âœ… å·²ä» /app/config/ æ¿€æ´»é…ç½®'
            elif [ -f '/app/config.example.yaml' ]; then
              mkdir -p /app/config
              cp /app/config.example.yaml /app/config/config.yaml
              echo 'âœ… å·²ä» /app/ æ¿€æ´»é…ç½®'
            else
              echo 'âš ï¸ æœªæ‰¾åˆ°ç¤ºä¾‹æ–‡ä»¶ï¼Œæ‰‹åŠ¨åˆ›å»ºåŸºç¡€é…ç½®'
              mkdir -p /app/config
              echo 'server:\n  port: 8199\n  web-control: true' > /app/config/config.yaml
            fi
          "
          
          # å¼ºè¡Œä¿®æ­£ï¼šå¼€å¯ Web é¢æ¿å¹¶é”å®šç«¯å£ä¸º 8199
          docker exec checker sed -i 's/web-control: false/web-control: true/g' /app/config/config.yaml || true
          docker exec checker sed -i 's/port: 8299/port: 8199/g' /app/config/config.yaml || true
          
          echo "ğŸ”„ é‡å¯å®¹å™¨åº”ç”¨æ–°é…ç½®..."
          docker restart checker
          sleep 10
          
          echo "ğŸ“‹ å®¹å™¨æœ€ç»ˆæ—¥å¿—è¯Šæ–­ï¼š"
          docker logs checker

      - name: 4. ç«¯å£æ•æ‰ä¸éš§é“ç”³è¯·
        run: |
          # å®‰è£… cloudflared
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          
          echo "ğŸŒ æ­£åœ¨å»ºç«‹ Cloudflare éš§é“..."
          # æ—¢ç„¶æˆ‘ä»¬å¼ºæ¨äº† 8199ï¼Œè¿™é‡Œé‡ç‚¹ç”³è¯· 8199
          nohup ./cloudflared tunnel --url http://127.0.0.1:8199 --logfile tunnel.log > /dev/null 2>&1 &
          
          # å¤‡ç”¨ï¼šä¹Ÿä¸º 8299 å¼€ä¸€ä¸ªï¼ˆé˜²æ­¢é•œåƒå†…éƒ¨æœ‰ç¡¬ç¼–ç åç§»ï¼‰
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel_alt.log > /dev/null 2>&1 &
          
          sleep 15
          URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
          URL_ALT=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel_alt.log | head -n 1)

          echo "------------------------------------------------"
          if [ -n "$URL" ]; then
            echo "âœ… æ¨èé“¾æ¥ (8199): $URL/admin"
          fi
          if [ -n "$URL_ALT" ]; then
            echo "ğŸ”— å¤‡ç”¨é“¾æ¥ (8299): $URL_ALT/admin"
          fi
          echo "------------------------------------------------"
          echo "ğŸ’¡ æç¤ºï¼šå¦‚æœä¾ç„¶ 404ï¼Œè¯·ç¡®ä¿åœ¨é“¾æ¥åæ‰‹åŠ¨æ·»åŠ  /admin"

      - name: 5. æŒ‚æœºä¿æ´» (15 åˆ†é’Ÿ)
        run: |
          for i in {15..1}; do
            echo "â³ éš§é“æœ‰æ•ˆæ—¶é—´å‰©ä½™: $i åˆ†é’Ÿ..."
            sleep 60
          done
