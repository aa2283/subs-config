name: Sub-Store Multi-Tunnel Service
on:
  workflow_dispatch:

jobs:
  launch:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: å¯åŠ¨å®¹å™¨å¹¶ç”³è¯·åŒè·¯éš§é“
        run: |
          # 1. å¼ºåŠ›æ¸…ç†æ—§å®¹å™¨
          docker rm -f checker || true
          
          # 2. å¯åŠ¨å®¹å™¨ (æ˜ç¡®æ˜ å°„ 8199 å’Œ 8299)
          echo "ğŸš€ å¯åŠ¨å®¹å™¨ä¸­..."
          docker run --name checker -d \
            -p 8199:8199 \
            -p 8299:8299 \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master

          # 3. å®æ—¶ç›‘æ§ï¼šçœ‹çœ‹å®ƒåˆ°åº•å¯åŠ¨åœ¨å“ª
          sleep 10
          echo "ğŸ“‹ å®¹å™¨å¯åŠ¨å®æ—¶æ—¥å¿—ï¼š"
          docker logs checker
          
          echo "ğŸ“¡ ç«¯å£ç›‘å¬çŠ¶æ€ç¡®è®¤ï¼š"
          sudo netstat -tunlp | grep -E '8199|8299'

      - name: å»ºç«‹ Cloudflare éš§é“
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          
          echo "ğŸŒ æ­£åœ¨ä¸ºä¸¤ä¸ªç«¯å£åˆ†åˆ«ç”³è¯·éš§é“..."
          nohup ./cloudflared tunnel --url http://127.0.0.1:8199 --logfile tunnel_8199.log > /dev/null 2>&1 &
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel_8299.log > /dev/null 2>&1 &
          
          sleep 15
          URL_8199=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel_8199.log | head -n 1)
          URL_8299=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel_8299.log | head -n 1)

          echo "------------------------------------------------"
          if [ -n "$URL_8199" ]; then
            echo "âœ… éš§é“ A (8199): $URL_8199/admin"
            echo "ğŸ”— å¦‚æœ 404ï¼Œå°è¯•: $URL_8199/"
          fi
          if [ -n "$URL_8299" ]; then
            echo "âœ… éš§é“ B (8299): $URL_8299/admin"
            echo "ğŸ”— å¦‚æœ 404ï¼Œå°è¯•: $URL_8299/"
          fi
          echo "------------------------------------------------"
          
          # æŒ‚æœºå€’è®¡æ—¶
          for i in {15..1}; do
            echo "â³ éš§é“å­˜æ´»ä¸­... $i åˆ†é’Ÿ"
            sleep 60
          done
