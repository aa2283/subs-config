name: Sub-Store Multi-Tunnel Service
on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  launch:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: 2. åˆå§‹åŒ–ç›®å½•ä¸æƒé™
        run: |
          # åˆ›å»ºæŒ‚è½½æ‰€éœ€çš„ç›®å½•
          mkdir -p ${{ github.workspace }}/temp_config
          mkdir -p ${{ github.workspace }}/output
          
          # 3. ã€æ ¸å¿ƒä¿®å¤ã€‘é¢„ç½® config.yaml ä»¥æ¿€æ´» Web é¢æ¿
          # è¿™ä¸€æ­¥è§£å†³äº†ä½ ä¹‹å‰çœ‹åˆ°çš„ "Webæ§åˆ¶é¢æ¿å·²ç¦ç”¨" é—®é¢˜
          cat <<EOF > ${{ github.workspace }}/temp_config/config.yaml
          server:
            port: 8199
            addr: 0.0.0.0
            web-control: true
          EOF
          
          # èµ‹äºˆæœ€é«˜è¯»å†™æƒé™ï¼Œé˜²æ­¢å®¹å™¨å› æƒé™é—®é¢˜æ— æ³•å¯åŠ¨
          sudo chmod -R 777 ${{ github.workspace }}/temp_config
          sudo chmod -R 777 ${{ github.workspace }}/output
          echo "âœ… ç›®å½•ä¸åŸºç¡€é…ç½®å·²å‡†å¤‡å°±ç»ª"

      - name: 3. å¯åŠ¨ Sub-Store é›†æˆå®¹å™¨
        run: |
          echo "ğŸš€ æ­£åœ¨å¯åŠ¨å®¹å™¨ (å®¿ä¸»æœºç½‘ç»œæ¨¡å¼)..."
          # ä½¿ç”¨ --network host ç¡®ä¿ç«¯å£æ˜ å°„æ— æŸä¸” cloudflared å¯ç›´æ¥ç©¿é€
          docker run --name checker -d \
            --network host \
            -v ${{ github.workspace }}/temp_config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master
          
          echo "â³ ç­‰å¾…æœåŠ¡åˆå§‹åŒ–..."
          sleep 10

      - name: 4. ç«¯å£æ•æ‰ä¸éš§é“ç”³è¯·
        run: |
          # å®‰è£… Cloudflared
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          
          echo "ğŸ” æ­£åœ¨æ•æ‰ç«¯å£å“åº”å¹¶ç”³è¯·éš§é“..."
          # åŒæ—¶ä¸º 8199 å’Œ 8299 ç”³è¯·éš§é“ï¼Œè§£å†³ 404 è·¯å¾„ä¸æ˜çš„é—®é¢˜
          nohup ./cloudflared tunnel --url http://localhost:8199 --logfile tunnel_8199.log > /dev/null 2>&1 &
          nohup ./cloudflared tunnel --url http://localhost:8299 --logfile tunnel_8299.log > /dev/null 2>&1 &
          
          # ç­‰å¾…éš§é“è¿æ¥å»ºç«‹å¹¶è·å– URL
          for i in {1..10}; do
            sleep 3
            URL_A=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel_8199.log | head -n 1 || echo "")
            URL_B=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel_8299.log | head -n 1 || echo "")
            if [ -n "$URL_A" ] || [ -n "$URL_B" ]; then break; fi
            echo "éš§é“ç”³è¯·ä¸­... ($i/10)"
          done

          echo "------------------------------------------------"
          if [ -n "$URL_A" ]; then
            echo "ğŸŒ éš§é“ A (ç«¯å£ 8199):"
            echo "ğŸ‘‰ ç®¡ç†åå°: $URL_A/admin"
            echo "ğŸ‘‰ æ ¹è·¯å¾„:   $URL_A/"
          fi
          echo "----------------"
          if [ -n "$URL_B" ]; then
            echo "ğŸŒ éš§é“ B (ç«¯å£ 8299):"
            echo "ğŸ‘‰ ç®¡ç†åå°: $URL_B/admin"
            echo "ğŸ‘‰ æ ¹è·¯å¾„:   $URL_B/"
          fi
          echo "------------------------------------------------"
          
          # æ‰“å°å®¹å™¨æ—¥å¿—ï¼Œå¦‚æœè¿˜æ˜¯ 404ï¼Œå¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°æœåŠ¡æŠ¥ä»€ä¹ˆé”™
          echo "ğŸ“‹ å®¹å™¨è¿è¡ŒçŠ¶æ€è¯Šæ–­ (æœ€å 15 è¡Œ):"
          docker logs --tail 15 checker

      - name: 5. æŒ‚æœºä¿ç•™æ¨¡å¼ (15 åˆ†é’Ÿ)
        run: |
          echo "â° éš§é“å·²å¼€å¯ã€‚è¯·åœ¨æµè§ˆå™¨è®¿é—®ä¸Šæ–¹ç”Ÿæˆçš„åœ°å€ã€‚"
          echo "ğŸ’¡ æ³¨æ„ï¼šå¦‚æœä¸€ä¸ªé“¾æ¥ 404ï¼Œè¯·å°è¯•å¦ä¸€ä¸ªç«¯å£çš„ /admin è·¯å¾„ã€‚"
          for i in {15..1}; do
            echo "â³ éš§é“æœ‰æ•ˆæ—¶é—´å‰©ä½™: $i åˆ†é’Ÿ..."
            sleep 60
          done
          echo "ğŸ”” æŒ‚æœºç»“æŸï¼Œæ­£åœ¨å…³é—­å®¹å™¨ä¸éš§é“ã€‚"
          docker kill checker || true
