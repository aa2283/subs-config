name: Sub-Store Integrated Sync-122æˆåŠŸ
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: 2. ç¯å¢ƒä¸éš§é“å‡†å¤‡
        run: |
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output
          # ä¸‹è½½å¹¶å¯åŠ¨éš§é“
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel.log > /dev/null 2>&1 &
          
          # ğŸ”„ ä½ çš„é‡è¯•å¾ªç¯ä»£ç 
          echo "â³ ç­‰å¾… Cloudflare åˆ†é…éš§é“åŸŸå..."
          for i in {1..20}; do
            API_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
            if [ -n "$API_URL" ]; then
              echo "âœ… æˆåŠŸè·å–åŸŸå: $API_URL"
              echo "TUNNEL_URL=$API_URL" >> $GITHUB_ENV
              echo "### ğŸŒ å®˜æ–¹å‰ç«¯åœ°å€: https://sub-store.vercel.app?api=$API_URL" >> $GITHUB_STEP_SUMMARY
              break
            fi
            echo "ç¬¬ $i ç§’: åŸŸåç”Ÿæˆä¸­..."
            sleep 1
          done

      - name: 3. æ‰§è¡Œæ£€æµ‹ (åå°è¿è¡Œï¼Œå›é¿æ—¥å¿—å¼¹å‡º)
        run: |
          # å¯åŠ¨å‰å…ˆæ‹‰å–ä»“åº“æ—§é…ç½®åˆ° output
          [ -f "sub-store.json" ] && cp sub-store.json ./output/sub-store.json || true

          # å¯åŠ¨å®¹å™¨
          docker run --name checker -d -p 8299:8299 \
            -v ${{ github.workspace }}/config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master

          # ã€å“¨å…µ Aã€‘ï¼šè´Ÿè´£æ£€æµ‹å®Œæˆåçš„é¦–è½®åŒæ­¥
          (
            while true; do
              sleep 10
              if ! docker ps | grep -q 'checker'; then break; fi
              LOGS=$(docker logs --tail 10 checker 2>&1 | sed 's/\x1b\[[0-9;]*m//g')
              if echo "$LOGS" | grep -qE "ä¿å­˜æœ¬åœ°æˆåŠŸ|èŠ‚ç‚¹ä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜"; then
                echo ">>> [å“¨å…µ] æ£€æµ‹å®Œæˆï¼Œæ‰§è¡Œé¦–è½®å¤‡ä»½..."
                cp -f output/all.yaml ./all.yaml || true
                cp -f output/sub-store.json ./sub-store.json || true
                git config --global user.email "bot@github.com"
                git config --global user.name "AutoBot"
                git add all.yaml sub-store.json
                git commit -m "ğŸš€ è‡ªåŠ¨åŒæ­¥ (æ£€æµ‹å®Œæˆ)" || true
                git push origin HEAD:${{ github.ref_name }}
                break 
              fi
            done
          ) &
          
          echo "------------------------------------------------"
          echo "ğŸš€ æ£€æµ‹å·²åœ¨åå°å¯åŠ¨ï¼Œè¯·ç›´æ¥è¿›å…¥ç½‘é¡µç«¯æŸ¥çœ‹è¿›åº¦ï¼š"
          echo "ğŸ”— https://sub-store.vercel.app?api=${{ env.TUNNEL_URL }}"
          echo "------------------------------------------------"

      

      - name: 4. åŒæ­¥ç»“æœå›ä»“åº“
        run: |
          if [ -s "output/all.yaml" ]; then
            cp -f output/all.yaml ./all.yaml
            git config --global user.email "bot@github.com"
            git config --global user.name "AutoBot"
            git add all.yaml
            git commit -m "ğŸš€ è‡ªåŠ¨åŒæ­¥èŠ‚ç‚¹: $(date +'%Y-%m-%d %H:%M')" || true
            git push origin HEAD:${{ github.ref_name }}
            echo "âœ… ä»“åº“åŒæ­¥æˆåŠŸï¼"
          else
            echo "âš ï¸ æœªå‘ç°æœ‰æ•ˆè¾“å‡ºæ–‡ä»¶ï¼Œè·³è¿‡åŒæ­¥ã€‚"
          fi

      - name: 5. æŒ‚æœºé”å®š (15åˆ†é’Ÿå®æ—¶åŒæ­¥ç½‘é¡µä¿®æ”¹)
        run: |
          echo "âœ¨ [å®æ—¶åŒæ­¥å·²å¼€å¯]ï¼šæ¯ 30 ç§’è‡ªåŠ¨ä¿å­˜æ‚¨çš„ç½‘é¡µä¿®æ”¹ã€‚"

          # ã€å“¨å…µ Bã€‘ï¼šè´Ÿè´£å®æ—¶ç›‘æ§ç½‘é¡µç«¯çš„ä¿®æ”¹
          (
            [ -f "output/sub-store.json" ] && LAST_MD5=$(md5sum output/sub-store.json | awk '{print $1}') || LAST_MD5=""
            while true; do
              sleep 30
              if [ -f "output/sub-store.json" ]; then
                CURRENT_MD5=$(md5sum output/sub-store.json | awk '{print $1}')
                if [ "$CURRENT_MD5" != "$LAST_MD5" ]; then
                  echo "ğŸ“¢ [å®æ—¶åŒæ­¥] å‘ç°é…ç½®å˜åŠ¨ï¼Œæ­£åœ¨æ¨é€..."
                  cp -f output/sub-store.json ./sub-store.json
                  git config --global user.email "bot@github.com"
                  git config --global user.name "AutoBot"
                  git add sub-store.json
                  git commit -m "ğŸ“ ç½‘é¡µç«¯å®æ—¶åŒæ­¥" && git push || true
                  LAST_MD5=$CURRENT_MD5
                fi
              fi
            done
          ) &

          # 15åˆ†é’Ÿå€’è®¡æ—¶æç¤º
          for i in {15..1}; do
            echo "â³ è·ç¦»ä»»åŠ¡ç»“æŸè¿˜å‰©: $i åˆ†é’Ÿ (ç½‘é¡µæ“ä½œä¸­...)"
            sleep 60
          done
