name: Sub-Store Integrated Sync-122æˆåŠŸ-å¸¦é…ç½®å¤‡ä»½
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: 2. ç¯å¢ƒä¸éš§é“å‡†å¤‡
        run: |
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output
          
          # ã€æ–°å¢ã€‘ï¼šå¯åŠ¨å‰å…ˆä»ä»“åº“æ‹‰å–æ—§é…ç½®ï¼Œç¡®ä¿è§„åˆ™ç”Ÿæ•ˆ
          [ -f "sub-store.json" ] && cp sub-store.json ${{ github.workspace }}/output/sub-store.json || true
          
          # ä¸‹è½½å¹¶å¯åŠ¨éš§é“
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel.log > /dev/null 2>&1 &
          
          echo "ç­‰å¾… Cloudflare åˆ†é…åŸŸå..."
          for i in {1..30}; do
            API_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
            if [ -n "$API_URL" ]; then
              echo "âœ… æˆåŠŸè·å–åŸŸå: $API_URL"
              echo "TUNNEL_URL=$API_URL" >> $GITHUB_ENV
              echo "### ğŸŒ å®˜æ–¹å‰ç«¯åœ°å€: https://sub-store.vercel.app?api=$API_URL" >> $GITHUB_STEP_SUMMARY
              break
            fi
            sleep 1
          done

          if [ -z "$API_URL" ]; then exit 1; fi

      - name: 3. æ‰§è¡Œä½ çš„æ£€æµ‹è„šæœ¬ (å®æ—¶è¿›åº¦+å“¨å…µ)
        run: |
          (
            echo ">>> [å“¨å…µ] å¯åŠ¨æˆåŠŸ..."
            HUNDRED_TIME=0
            while true; do
              sleep 10
              if ! docker ps | grep -q 'checker'; then break; fi
              LOGS=$(docker logs --tail 20 checker 2>&1 | sed 's/\x1b\[[0-9;]*m//g')
              
              if echo "$LOGS" | grep -qE "ä¿å­˜æœ¬åœ°æˆåŠŸ|èŠ‚ç‚¹ä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜"; then
                echo ">>> [å“¨å…µæŠ¥å‘Š] ä»»åŠ¡å®Œæˆï¼æ‰§è¡Œå¼ºåˆ¶æ”¶å‰²..."
                docker kill checker || true
                break
              fi
              
              if echo "$LOGS" | grep -q "100.0%"; then
                HUNDRED_TIME=$((HUNDRED_TIME + 10))
                if [ $HUNDRED_TIME -ge 120 ]; then
                  docker kill checker || true
                  break
                fi
              else
                HUNDRED_TIME=0
              fi
            done
          ) &

          echo "ğŸš€ å¯åŠ¨å®¹å™¨ï¼Œè¿›åº¦å°†å®æ—¶æ˜¾ç¤º..."
          docker run --name checker --rm -t \
            -p 8299:8299 \
            -v ${{ github.workspace }}/config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master || [ $? -eq 137 ] || [ $? -eq 143 ]

      - name: 4. åŒæ­¥ç»“æœå›ä»“åº“ (èŠ‚ç‚¹+é…ç½®)
        run: |
          git config --global user.email "bot@github.com"
          git config --global user.name "AutoBot"
          
          # åŒæ—¶å¤‡ä»½ all.yaml å’Œ sub-store.json
          [ -s "output/all.yaml" ] && cp -f output/all.yaml ./all.yaml || true
          [ -f "output/sub-store.json" ] && cp -f output/sub-store.json ./sub-store.json || true
          
          git add all.yaml sub-store.json
          git commit -m "ğŸš€ è‡ªåŠ¨åŒæ­¥ (èŠ‚ç‚¹+é…ç½®): $(date +'%H:%M')" || true
          git push origin HEAD:${{ github.ref_name }}

      - name: 5. æŒ‚æœºé”å®š (15åˆ†é’Ÿå®æ—¶åŒæ­¥ç½‘é¡µä¿®æ”¹)
        run: |
          docker rm -f checker >/dev/null 2>&1 || true
          docker run --name checker -d -p 8299:8299 \
            -v ${{ github.workspace }}/config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master >/dev/null

          # ã€æ–°å¢ã€‘ï¼šæŒ‚æœºæœŸé—´çš„å®æ—¶åŒæ­¥å“¨å…µ
          (
            while true; do
              sleep 30
              # æ£€æŸ¥ output ç›®å½•ä¸‹çš„ json æ˜¯å¦æœ‰å˜åŠ¨å¹¶åŒæ­¥
              if [ -n "$(git status --porcelain output/sub-store.json)" ] || [ -n "$(git diff sub-store.json output/sub-store.json)" ]; then
                cp -f output/sub-store.json ./sub-store.json || true
                git add sub-store.json
                git commit -m "ğŸ“ ç½‘é¡µç«¯é…ç½®å®æ—¶å¤‡ä»½: $(date +'%H:%M')" && git push || true
              fi
            done
          ) &

          for i in {15..1}; do
            echo "â³ è·ç¦»éš§é“è‡ªåŠ¨å…³é—­è¿˜å‰©: $i åˆ†é’Ÿ (å®æ—¶åŒæ­¥ä¸­)"
            sleep 60
          done
