name: Subs-Check 终极稳定版

on:
  schedule:
    - cron: '15 4 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 检出代码
        uses: actions/checkout@v4

      - name: 2. 准备配置 (极稳模式)
        run: |
          mkdir -p ${{ github.workspace }}/output ${{ github.workspace }}/temp_config ${{ github.workspace }}/rename
          chmod -R 777 ${{ github.workspace }}/output
          export RAW_URLS_DATA="${{ secrets.SUB_URLS }}"
          python3 -c "
          import os
          template_path = '${{ github.workspace }}/config/config.yaml'
          output_path = '${{ github.workspace }}/temp_config/config.yaml'
          raw_urls = os.environ.get('RAW_URLS_DATA', '').strip().split('\n')
          formatted_urls = [f'  - \"{u.strip()}\"\n' for u in raw_urls if len(u.strip()) > 10]
          new_lines = [
              'web-panel: true\n', 
              'api-port: 8199\n', 
              'sub-store-port: 8299\n',
              'concurrent: 50\n',      # 【核心改动】降速保稳，防止崩溃
              'watch: false\n',
              'cron: \"\"\n'
          ]
          with open(template_path, 'r', encoding='utf-8') as f:
              for line in f:
                  if any(x in line for x in ['web-panel', 'api-port', 'sub-store-port', 'concurrent', 'watch', 'cron']): continue
                  if '{SUB_URLS}' in line: new_lines.extend(formatted_urls)
                  else: new_lines.append(line)
          with open(output_path, 'w', encoding='utf-8') as f:
              f.writelines(new_lines)
          "

      - name: 3. 【第一步】稳健检测 (严防进度倒退)
        run: |
          echo "🚀 启动稳健检测模式..."
          docker run -d --name checker \
            --memory="2500m" \
            -p 8199:8199 -p 8299:8299 \
            -v ${{ github.workspace }}/temp_config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master
          
          LAST_PERCENT=0
          while true; do
            LOGS=$(docker logs --tail 10 checker 2>&1 | sed 's/\x1b\[[0-9;]*m//g')
            # 提取百分比数字
            CURRENT_LINE=$(echo "$LOGS" | grep "进度:" | tail -n 1)
            echo "$CURRENT_LINE" || true
            
            # 检查是否有完成信号
            if echo "$LOGS" | grep -qE "保存本地成功|节点为空"; then
              echo "✅ 检测完成！"
              break
            fi
            
            # 进度回退检测逻辑
            CURRENT_PERCENT=$(echo "$CURRENT_LINE" | grep -oE "[0-9.]+" | head -n 1 || echo 0)
            # 如果当前进度比上次小很多（说明重启了），且上次已经跑了不少了，直接强制收割
            if (( $(echo "$CURRENT_PERCENT < $LAST_PERCENT" | bc -l) )) && (( $(echo "$LAST_PERCENT > 5" | bc -l) )); then
               echo "⚠️ 检测到进度重置，可能程序已崩溃重启。为防止死循环，执行强制收割..."
               break
            fi
            LAST_PERCENT=$CURRENT_PERCENT
            
            # 超时保护
            if [ $SECONDS -gt 3600 ]; then echo "❌ 耗时过长，强制退出"; break; fi
            sleep 20
          done

      - name: 4. 【第二步】收割结果 (趁热打铁)
        run: |
          echo "📥 正在从后端下载文件..."
          # 稍等片刻确保接口响应
          sleep 10
          curl -s "http://127.0.0.1:8299/download/rename?target=URI" -o "${{ github.workspace }}/rename/URI.txt"
          curl -s "http://127.0.0.1:8299/download/rename?target=ClashMeta" -o "${{ github.workspace }}/rename/ClashMeta.yaml"
          sudo chown -R $USER:$USER ${{ github.workspace }}/output
          sudo chown -R $USER:$USER ${{ github.workspace }}/rename

      - name: 5. 【第三步】推送至 GitHub
        uses: actions/checkout@v4
        with:
          repository: aa2283/v2ray_configs
          token: ${{ secrets.PAT_TOKEN }}
          path: target-repo

      - name: 6. 执行 Git 推送
        run: |
          cd target-repo
          mkdir -p sub rename
          rm -rf sub/* rename/*
          cp -rv ../output/* sub/ --exclude=*.log || true
          cp -rv ../rename/* rename/
          git config --local user.email "actions@github.com"
          git config --local user.name "Action"
          git add .
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Update Nodes $(date)"
            git push
          fi

      - name: 7. 【第四步】保活挂机 15 分钟
        env:
          MY_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          touch tunnel.log
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel.log > /dev/null 2>&1 &
          
          echo "🔄 绑定调试域名..."
          for i in {1..20}; do
            if [ -f "tunnel.log" ]; then
                API_URL=$(grep -o 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | tail -n 1)
                if [ -n "$API_URL" ]; then
                  echo "::add-mask::$API_URL"
                  SHA=$(curl -s -H "Authorization: token $MY_TOKEN" "https://api.github.com/repos/aa2283/v2ray_configs/contents/tunnel_url.txt" | grep -o '"sha": "[^"]*' | cut -d'"' -f4 || echo "")
                  CONTENT=$(echo -n "$API_URL" | base64 | tr -d '\n')
                  curl -s -o /dev/null -X PUT -H "Authorization: token $MY_TOKEN" -H "Content-Type: application/json" \
                    -d "{\"message\":\"Update API\",\"content\":\"$CONTENT\",\"sha\":\"$SHA\"}" \
                    "https://api.github.com/repos/aa2283/v2ray_configs/contents/tunnel_url.txt"
                  echo "🌍 调试域名: $API_URL"
                  break
                fi
            fi
            sleep 5
          done

          echo "🕒 挂机时间开始..."
          for i in {1..15}; do
            echo ">>> [常驻运行] $i/15 min"
            sleep 60
          done
          docker kill checker || true
