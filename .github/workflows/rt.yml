name: Subs-Check å®Œç¾ç‰ˆ (å…ˆéš§é“åæ£€æµ‹)

on:
  schedule:
    - cron: '15 4 * * *'
  workflow_dispatch:

jobs:
  check-subscriptions:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 2. ç”Ÿæˆé…ç½® (å¼ºåˆ¶å¼€å¯é¢æ¿)
        run: |
          mkdir -p ${{ github.workspace }}/output
          mkdir -p ${{ github.workspace }}/temp_config
          chmod -R 777 ${{ github.workspace }}/output
          export RAW_URLS_DATA="${{ secrets.SUB_URLS }}"
          python3 -c "
          import os
          template_path = '${{ github.workspace }}/config/config.yaml'
          output_path = '${{ github.workspace }}/temp_config/config.yaml'
          raw_urls = os.environ.get('RAW_URLS_DATA', '').strip().split('\n')
          formatted_urls = [f'  - \"{u.strip()}\"\n' for u in raw_urls if len(u.strip()) > 10]
          new_lines = ['web-panel: true\n', 'api-port: 8199\n', 'sub-store-port: 8299\n']
          if os.path.exists(template_path):
              with open(template_path, 'r', encoding='utf-8') as f:
                  for line in f:
                      if any(x in line for x in ['web-panel', 'api-port', 'sub-store-port']): continue
                      if '{SUB_URLS}' in line: new_lines.extend(formatted_urls)
                      else: new_lines.append(line)
          else:
              new_lines.append('sub-urls:\n')
              new_lines.extend(formatted_urls)
          with open(output_path, 'w', encoding='utf-8') as f:
              f.writelines(new_lines)
          "

      - name: 3. å¯åŠ¨ Sub-Store åç«¯ (8299)
        run: |
          # ä»…å…ˆç¡®ä¿åç«¯åŸºç¡€æœåŠ¡å¯åŠ¨ï¼Œä¸è§¦å‘è‡ªåŠ¨æ£€æµ‹ï¼ˆå¦‚æœé•œåƒæ”¯æŒåˆ†ç¦»å¯åŠ¨ï¼‰
          # æ³¨æ„ï¼šæœ‰äº›é•œåƒå¯åŠ¨å³æ£€æµ‹ï¼Œæˆ‘ä»¬é€šè¿‡æ˜ å°„ç¡®ä¿ 8299 ä¼˜å…ˆ
          docker run -d --name checker \
            -p 8199:8199 \
            -p 8299:8299 \
            -v ${{ github.workspace }}/temp_config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master
          
          echo "â³ ç­‰å¾… Sub-Store (8299) å“åº”..."
          for i in {1..20}; do
            if curl -s http://127.0.0.1:8299 > /dev/null; then
              echo "âœ… åç«¯ 8299 å·²å°±ç»ª"
              break
            fi
            sleep 2
          done

      - name: 4. ç¨³å¥å»ºç«‹éš§é“ (æ­¤æ—¶ç½‘ç»œç©ºé—²)
        env:
          MY_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "ğŸ“¥ ä¸‹è½½å¹¶å¯åŠ¨éš§é“..."
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          
          # è½¬å‘ 8299 ä½œä¸ºä¸»å…¥å£
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel.log > /dev/null 2>&1 &
          
          echo "ğŸ”„ æ•è·åŸŸåä¸­..."
          for i in {1..30}; do
            API_URL=$(grep -o 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | tail -n 1)
            if [ -n "$API_URL" ]; then
              echo "âœ… éš§é“æˆåŠŸ: $API_URL"
              echo "::add-mask::$API_URL"
              echo "FINAL_API_URL=$API_URL" >> $GITHUB_ENV
              
              # ç«‹å³åŒæ­¥åˆ°ç§æœ‰åº“ï¼Œé˜²æ­¢åç»­æ£€æµ‹å ç”¨å¸¦å®½å¯¼è‡´åŒæ­¥è¶…æ—¶
              SHA=$(curl -s -H "Authorization: token $MY_TOKEN" "https://api.github.com/repos/aa2283/v2ray_configs/contents/tunnel_url.txt" | grep -o '"sha": "[^"]*' | cut -d'"' -f4 || echo "")
              CONTENT=$(echo -n "$API_URL" | base64 | tr -d '\n')
              curl -s -o /dev/null -X PUT -H "Authorization: token $MY_TOKEN" -H "Content-Type: application/json" \
                -d "{\"message\":\"Update API\",\"content\":\"$CONTENT\",\"sha\":\"$SHA\"}" \
                "https://api.github.com/repos/aa2283/v2ray_configs/contents/tunnel_url.txt"
              break
            fi
            sleep 2
          done

      - name: 5. è§¦å‘å¹¶ç›‘å¬æ£€æµ‹ç•Œé¢ (8199)
        run: |
          echo "ğŸš€ éš§é“å·²ç¨³å›ºï¼ŒWorker å·²æŒ‡å‘ $FINAL_API_URL"
          echo "ğŸ“¢ ç°åœ¨å¼€å§‹æ‰§è¡Œå¤§è§„æ¨¡èŠ‚ç‚¹æ£€æµ‹..."
          
          # è¿™é‡Œå¯ä»¥å°è¯•è°ƒç”¨ä¸€æ¬¡ API è§¦å‘æ£€æµ‹ï¼ˆå¦‚æœè¯¥é•œåƒæœ‰è§¦å‘æ¥å£ï¼‰ï¼Œæˆ–è€…ç›´æ¥å¼€å§‹ç›‘å¬æ—¥å¿—
          for i in {1..15}; do
            echo ">>> [å¸¸é©»è¿è¡Œ] ç¬¬ $i/15 åˆ†é’Ÿ"
            
            # å®æ—¶æ˜¾ç¤ºè¿›åº¦
            LOGS=$(docker logs --tail 10 checker 2>&1 | sed 's/\x1b\[[0-9;]*m//g')
            echo "$LOGS" | grep "è¿›åº¦:" | tail -n 1 || true
            
            # å³ä½¿ä¿å­˜æˆåŠŸä¹Ÿä¸æå‰é€€å‡ºï¼Œå¼ºåˆ¶æŒ‚å¤Ÿ 15 åˆ†é’Ÿ
            if echo "$LOGS" | grep -q "ä¿å­˜æœ¬åœ°æˆåŠŸ"; then
              echo "âœ… æ£€æµ‹å·²å®Œæˆå¹¶å­˜ç›˜ï¼Œç»§ç»­ä¿æŒæŒ‚æœºä»¥ä¾›è°ƒè¯•..."
            fi
            
            sleep 60
          done
          docker kill checker || true

      - name: 6. æäº¤ç»“æœ
        uses: actions/checkout@v4
        with:
          repository: aa2283/v2ray_configs
          token: ${{ secrets.PAT_TOKEN }}
          path: target-repo

      - name: 7. æ¨é€
        run: |
          cd target-repo
          mkdir -p sub && cp -rv ../output/. sub/
          git config --local user.email "actions@github.com"
          git config --local user.name "Action"
          git add .
          git commit -m "Update Nodes" || echo "No changes"
          git push
