name: Subs-Check & Sub-Store å®Œç¾ç¼åˆç‰ˆ-ä¼˜åŒ–ç‰ˆ

on:
  #schedule:
    #- cron: '15 4 * * *'
  workflow_dispatch:

jobs:
  check-subscriptions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run subscription checker
        run: |
          # 1. å‡†å¤‡ç›®å½•
          mkdir -p ${{ github.workspace }}/output
          mkdir -p ${{ github.workspace }}/temp_config
          chmod -R 755 ${{ github.workspace }}/output ${{ github.workspace }}/temp_config

          # 2. æ³¨å…¥è®¢é˜… URL åˆ° config.yaml
          export RAW_URLS_DATA="${{ secrets.SUB_URLS }}"
          python3 - <<EOF
          import os
          template_path = '${{ github.workspace }}/config/config.yaml'
          output_path = '${{ github.workspace }}/temp_config/config.yaml'
          raw_urls = os.environ.get('RAW_URLS_DATA', '').strip().split('\n')
          formatted_urls = [f' - "{u.strip()}"\n' for u in raw_urls if len(u.strip()) > 10]
          new_lines = ['show-useless-url: true\n']
          with open(template_path, 'r', encoding='utf-8') as f:
              for line in f:
                  if '{SUB_URLS}' in line:
                      new_lines.extend(formatted_urls)
                  elif 'show-useless-url' in line:
                      continue
                  else:
                      new_lines.append(line)
          with open(output_path, 'w', encoding='utf-8') as f:
              f.writelines(new_lines)
          EOF

          # 3. å“¨å…µæœºåˆ¶ï¼šç›‘æ§ checker å®¹å™¨å¹¶é€‚æ—¶ç»ˆæ­¢
          (
            echo ">>> [å“¨å…µ] å¯åŠ¨æˆåŠŸï¼Œæ­£åœ¨ç›‘æ§..."
            HUNDRED_TIME=0
            while true; do
              sleep 10
              if ! docker ps | grep -q 'checker'; then break; fi

              LOGS=$(docker logs --tail 30 checker 2>&1 | sed 's/\x1b\[[0-9;]*m//g')

              if echo "$LOGS" | grep -qE "ä¿å­˜æœ¬åœ°æˆåŠŸ|èŠ‚ç‚¹ä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜"; then
                echo ">>> [å“¨å…µ] æ£€æµ‹åˆ°ä¿å­˜å®Œæˆä¿¡å·ï¼Œå‡†å¤‡ç»ˆæ­¢..."
                docker kill checker || true
                break
              fi

              if echo "$LOGS" | grep -q "100.0%"; then
                HUNDRED_TIME=$((HUNDRED_TIME + 10))
                echo ">>> [å“¨å…µ] è¿›åº¦ 100%ï¼Œä¿åº•å€’è®¡æ—¶: ${HUNDRED_TIME}/180 ç§’"
                if [ $HUNDRED_TIME -ge 180 ]; then
                  echo ">>> [å“¨å…µ] è¶…æ—¶å¼ºåˆ¶ç»ˆæ­¢"
                  docker kill checker || true
                  break
                fi
              else
                HUNDRED_TIME=0
              fi
            done
          ) &

          # 4. è¿è¡Œ checkerï¼ˆå‰å°å±•ç¤ºè¿›åº¦ï¼‰
          docker run --name checker --rm -i \
            -v ${{ github.workspace }}/temp_config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master || [ $? -eq 137 ] || [ $? -eq 143 ]

          echo ">>> æ£€æµ‹é˜¶æ®µå®Œæˆï¼Œè¿›å…¥ Sub-Store æœåŠ¡å¯åŠ¨ã€‚"

      - name: å¯åŠ¨ Sub-Store åå°æœåŠ¡
    run: |
     ROOT_DIR=$(pwd)
     mkdir -p $ROOT_DIR/temp_config $ROOT_DIR/output
     echo "show-useless-url: true" > $ROOT_DIR/temp_config/config.yaml
     # åˆ é™¤ä¸‹é¢è¿™è¡Œï¼
     # chmod -R 755 $ROOT_DIR/output $ROOT_DIR/temp_config

     docker rm -f substore-svc 2>/dev/null || true

     docker run -d --name substore-svc \
      -p 8299:8299 \
      -v $ROOT_DIR/temp_config:/app/config \
      -v $ROOT_DIR/output:/app/output \
      -v $ROOT_DIR/output:/app/data \
      ghcr.io/aa2283/subs-check:master

     echo "âœ… Sub-Store åå°æœåŠ¡å·²å¯åŠ¨ï¼ˆç«¯å£ 8299ï¼‰"
      - name: æ¿€æ´» Sub-Store åç«¯
        run: |
          echo "ğŸŒ æ­£åœ¨å”¤é†’å¹¶æ¿€æ´» Sub-Store æœåŠ¡..."
          curl -s "https://sub-store.vercel.app?api=http://127.0.0.1:8299" > /dev/null
          sleep 8
          curl -s "http://127.0.0.1:8299/api/utils/version" || echo "ç‰ˆæœ¬æ¥å£å”¤é†’ä¸­..."
          sleep 5

          if netstat -tuln | grep -q ":8299"; then
            echo "ğŸš€ ç«¯å£ 8299 å·²å°±ç»ªï¼"
          else
            echo "âš ï¸ ç«¯å£æœªç›‘å¬ï¼ŒæŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼š"
            docker logs substore-svc --tail 30
          fi

      - name: å¼€å¯ Cloudflared éš§é“å¹¶æå–åŸŸå
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared

          echo "ğŸš€ å¯åŠ¨ Cloudflared éš§é“..."
          ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile cloudflared.log > tunnel.log 2>&1 &

          API_URL=""
          for i in {1..40}; do
            API_URL=$(grep -oE 'https://[a-z0-9-]*\.trycloudflare\.com' tunnel.log cloudflared.log 2>/dev/null | head -n1)
            if [ -n "$API_URL" ] && grep -q "Registered tunnel connection" cloudflared.log 2>/dev/null; then
              echo "::add-mask::$API_URL"
              echo "FINAL_API_URL=$API_URL" >> $GITHUB_ENV
              echo "âœ… éš§é“å»ºç«‹æˆåŠŸï¼è®¿é—®åœ°å€ï¼š$API_URL"
              break
            fi
            echo "â³ ç­‰å¾…éš§é“æ³¨å†Œ... ($i/40)"
            sleep 4
          done

          if [ -z "$API_URL" ]; then
            echo "âŒ éš§é“å»ºç«‹å¤±è´¥ï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š"
            cat tunnel.log || true
            cat cloudflared.log || true
            exit 1
          fi

      - name: åŒæ­¥éš§é“åŸŸååˆ°ç§æœ‰ä»“åº“
        env:
          MY_TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO: "aa2283/v2ray_configs"
          FILE: "tunnel_url.txt"
        run: |
          set +x
          echo "ğŸ”„ æ­£åœ¨å°†éš§é“åŸŸååŠ å¯†åŒæ­¥åˆ°ç§æœ‰ä»“åº“..."

          SHA=$(curl -s -H "Authorization: token $MY_TOKEN" \
            "https://api.github.com/repos/$REPO/contents/$FILE" | grep '"sha"' | cut -d'"' -f4 || echo "")

          CONTENT=$(echo -n "${{ env.FINAL_API_URL }}" | base64 -w0)

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X PUT \
            -H "Authorization: token $MY_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "{\"message\":\"Update tunnel URL\",\"content\":\"$CONTENT\",\"sha\":\"$SHA\"}" \
            "https://api.github.com/repos/$REPO/contents/$FILE")

          if [[ "$HTTP_CODE" == 200 || "$HTTP_CODE" == 201 ]]; then
            echo "âœ… éš§é“åŸŸåå·²å®‰å…¨åŒæ­¥åˆ°ç§æœ‰ä»“åº“"
          else
            echo "âŒ åŒæ­¥å¤±è´¥ï¼ŒHTTP çŠ¶æ€ç : $HTTP_CODE"
            exit 1
          fi

      - name: æ£€å‡ºç§æœ‰ä»“åº“ï¼ˆç”¨äºåç»­åŒæ­¥ï¼‰
        uses: actions/checkout@v4
        with:
          repository: aa2283/v2ray_configs
          token: ${{ secrets.PAT_TOKEN }}
          path: target_repo_sync

      - name: å®æ—¶ç›‘å¬å¹¶æ¨é€è®¢é˜…æ›´æ–°ï¼ˆ15è½® Ã— 60ç§’ï¼‰
        run: |
          mkdir -p subs sub-store-data

          for i in {1..15}; do
            echo ">>> ç¬¬ $i/15 æ¬¡æ£€æŸ¥ï¼ˆ$(date +'%H:%M:%S')ï¼‰"

            # æ£€æŸ¥åç«¯æ˜¯å¦å­˜æ´»
            if ! curl -s --connect-timeout 8 http://127.0.0.1:8299 > /dev/null; then
              echo "âŒ Sub-Store æœåŠ¡æ— æ³•è¿æ¥ï¼Œç­‰å¾… 60 ç§’åé‡è¯•..."
              sleep 60
              continue
            fi

            # ä¸‹è½½æœ€æ–°è®¢é˜…
            curl -s "http://127.0.0.1:8299/download/rename?target=ClashMeta" -o subs/new_clash.yaml
            curl -s "http://127.0.0.1:8299/download/rename?target=URI" -o subs/new_uri.txt

            # ç®€å•æœ‰æ•ˆæ€§æ ¡éªŒ
            if ! grep -q "proxies" subs/new_clash.yaml && ! grep -q "://" subs/new_uri.txt; then
              echo "âš ï¸ å°šæœªè·å–åˆ°æœ‰æ•ˆèŠ‚ç‚¹ï¼Œç»§ç»­ç­‰å¾…..."
              sleep 60
              continue
            fi

            # æ£€æµ‹æ˜¯å¦æœ‰æ›´æ–°
            if [ ! -f "subs/all.yaml" ] || [ ! -f "subs/all.txt" ] || \
               ! cmp -s "subs/new_clash.yaml" "subs/all.yaml" || \
               ! cmp -s "subs/new_uri.txt" "subs/all.txt"; then

              echo "ğŸ“¢ æ£€æµ‹åˆ°è®¢é˜…æ›´æ–°ï¼Œæ­£åœ¨æ¨é€..."

              cp subs/new_clash.yaml subs/all.yaml
              cp subs/new_uri.txt subs/all.txt

              # å¤‡ä»½ sub-store.json
              docker cp substore-svc:/app/data/sub-store.json ./sub-store-data/sub-store.json || echo "å¤‡ä»½å¤±è´¥"

              # æ¨é€è‡³å½“å‰ä»“åº“
              git config user.email "actions@github.com"
              git config user.name "GitHub Action"
              git add subs/all.yaml subs/all.txt sub-store-data/sub-store.json
              git commit -m "è‡ªåŠ¨æ›´æ–°è®¢é˜… $(date +'%H:%M:%S')" || echo "æ— å˜åŠ¨"
              git pull --rebase origin main
              git push origin main

              # åŒæ­¥è‡³ v2ray_configs ä»“åº“
              cp subs/all.yaml target_repo_sync/subs/all.yaml
              cp subs/all.txt target_repo_sync/subs/all.txt

              cd target_repo_sync
              git config user.email "actions@github.com"
              git config user.name "GitHub Action"
              git add subs/all.yaml subs/all.txt
              git commit -m "å®æ—¶æ›´æ–°è®¢é˜… $(date +'%H:%M:%S')" || echo "æ— å˜åŠ¨"
              git push origin main
              cd ..
              echo "ğŸš€ å·²åŒæ­¥åˆ° v2ray_configs ä»“åº“ï¼"

            else
              echo "ğŸ˜´ æœ¬è½®æ— æ›´æ–°"
            fi

            echo "âœ… æœ¬è½®æ£€æŸ¥å®Œæˆï¼Œç­‰å¾…ä¸‹ä¸€è½®..."
            sleep 60
          done

          echo "ğŸ æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œå¼€å§‹æ¸…ç†"

      - name: æ¸…ç†å®¹å™¨
        if: always()
        run: |
          docker rm -f substore-svc checker || true
          docker system prune -f
