name: Sub-Store Direct UI Sync 25
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: 2. ç¯å¢ƒå‡†å¤‡
        run: |
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output
          
          # æå‰ä¸‹è½½å¹¶å¯åŠ¨éš§é“ï¼Œä¸å¹²æ‰°ä¸»æµç¨‹
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel.log > /dev/null 2>&1 &

      - name: 3. å¯åŠ¨å¹¶ç›´æ¥æ˜¾ç¤ºæ£€æµ‹è¿›åº¦ (æ ¸å¿ƒä¿®æ”¹)
        run: |
          echo "ğŸš€ æ­£åœ¨å¯åŠ¨å®¹å™¨ï¼Œå³å°†å¼€å§‹å®æ—¶æ£€æµ‹..."
          
          # ä¸åŠ  -dï¼Œç›´æ¥å‰å°è¿è¡Œï¼Œè¿›åº¦æ¡ä¼šç«‹å³å¼¹å‡º
          # è¿™æ ·ä½ åœ¨ GitHub Action ç•Œé¢ç‚¹å¼€è¿™ä¸€æ­¥å°±èƒ½çœ‹åˆ°è¿›åº¦ 0% -> 100%
          docker run --name sub-backend \
            -p 8299:8299 \
            -v ${{ github.workspace }}/config/config.yaml:/app/config/config.yaml \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master &
          
          # ç­‰å¾…å‡ ç§’è®©éš§é“åˆ†é…åŸŸå
          sleep 10
          API_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
          
          echo ""
          echo "------------------------------------------------"
          echo "ğŸ”— å®˜æ–¹å‰ç«¯è¿æ¥ (æ£€æµ‹è¿‡ç¨‹ä¸­ä¹Ÿå¯ç‚¹å‡»):"
          echo "https://sub-store.vercel.app?api=$API_URL"
          echo "------------------------------------------------"
          echo ""
          
          # å…³é”®ï¼šæ¥ç®¡å®¹å™¨æ—¥å¿—å¹¶æŒç»­è¾“å‡ºï¼Œç›´åˆ°æ£€æµ‹å®Œæˆ
          docker logs -f sub-backend

      - name: 4. æ£€æµ‹å®Œæˆåçš„åŒæ­¥ä¸æŒ‚æœº
        run: |
          echo "ğŸ¯ æ•è·åˆ°å®¹å™¨è¿è¡Œç»“æŸæˆ–æ£€æµ‹å®Œæˆï¼Œå¼€å§‹åŒæ­¥ä»“åº“..."
          
          if [ -s "output/all.yaml" ]; then
            cp -f output/all.yaml ./all.yaml
            git config --global user.email "bot@github.com"
            git config --global user.name "AutoBot"
            git add all.yaml
            git commit -m "Auto Update Nodes: $(date +'%Y-%m-%d %H:%M')" || true
            git push origin HEAD:${{ github.ref_name }}
            echo "âœ… ç»“æœå·²åŒæ­¥å›ä»“åº“ï¼"
          fi

          # ä¿æŒéš§é“å¼€å¯ä¸€æ®µæ—¶é—´ï¼Œæ–¹ä¾¿ä½ ç‚¹å‡»ä¸Šé¢çš„é“¾æ¥è¿›è¡Œæ‰‹åŠ¨æ“ä½œ
          echo "â³ éš§é“å°†ä¿æŒ 30 åˆ†é’Ÿä¾›ä½ æ‰‹åŠ¨è°ƒè¯•..."
          sleep 1800
