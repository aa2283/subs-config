name: Sub-Store Integrated Sync
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: 2. ç¯å¢ƒä¸éš§é“å‡†å¤‡
        run: |
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output
          # å¯åŠ¨éš§é“
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel.log > /dev/null 2>&1 &
          sleep 5
          API_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
          echo "TUNNEL_URL=$API_URL" >> $GITHUB_ENV
          echo "### ğŸŒ å®˜æ–¹å‰ç«¯åœ°å€: https://sub-store.vercel.app?api=$API_URL" >> $GITHUB_STEP_SUMMARY

      - name: 3. æ‰§è¡Œä½ çš„æ£€æµ‹è„šæœ¬ (å®æ—¶è¿›åº¦+å“¨å…µ)
        run: |
          # 1. å¯åŠ¨ä½ çš„å“¨å…µé€»è¾‘ (åå°)
          (
            echo ">>> [å“¨å…µ] å¯åŠ¨æˆåŠŸï¼Œæ­£åœ¨æš—ä¸­è§‚å¯Ÿ..."
            HUNDRED_TIME=0
            while true; do
              sleep 10
              if ! docker ps | grep -q 'checker'; then break; fi
              
              # æŠ“å–å¹¶æ¸…æ´—æ—¥å¿—
              LOGS=$(docker logs --tail 20 checker 2>&1 | sed 's/\x1b\[[0-9;]*m//g')
              
              # ä¿¡å· Aï¼šæ£€æµ‹åˆ°â€œä¿å­˜æœ¬åœ°æˆåŠŸâ€æˆ–è€…â€œèŠ‚ç‚¹ä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜â€
              if echo "$LOGS" | grep -qE "ä¿å­˜æœ¬åœ°æˆåŠŸ|èŠ‚ç‚¹ä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜"; then
                echo ">>> [å“¨å…µæŠ¥å‘Š] æ£€æµ‹åˆ°ç¨‹åºå·²è¾“å‡ºç»“æŸä¿¡å·ï¼å³å°†å¼ºåˆ¶æ€æ‰è¿›ç¨‹åŒæ­¥..."
                docker kill checker || true
                break
              fi
              
              # ä¿¡å· Bï¼šè¿›åº¦ 100% å€’è®¡æ—¶
              if echo "$LOGS" | grep -q "100.0%"; then
                HUNDRED_TIME=$((HUNDRED_TIME + 10))
                echo ">>> [å“¨å…µæŠ¥å‘Š] æ£€æµ‹åˆ°è¿›åº¦ 100%ï¼Œå­˜ç›˜ä¿åº•å€’è®¡æ—¶: ${HUNDRED_TIME}/120 ç§’"
                if [ $HUNDRED_TIME -ge 120 ]; then
                  echo ">>> [å“¨å…µæŠ¥å‘Š] å€’è®¡æ—¶ç»“æŸï¼æ‰§è¡Œå¼ºåˆ¶æ”¶å‰²..."
                  docker kill checker || true
                  break
                fi
              else
                HUNDRED_TIME=0
              fi
            done
          ) &

          # 2. å‰å°è¿è¡Œ (æ·»åŠ  -t å‚æ•°ç¡®ä¿è¿›åº¦å®æ—¶æ˜¾ç¤º)
          echo "ğŸš€ å¯åŠ¨å®¹å™¨ï¼Œè¿›åº¦å°†å®æ—¶æ˜¾ç¤º..."
          docker run --name checker --rm -t \
            -p 8299:8299 \
            -v ${{ github.workspace }}/config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master || [ $? -eq 137 ] || [ $? -eq 143 ]
          
          echo ">>> [æµç¨‹] æ£€æµ‹é˜¶æ®µå·²è·³å‡ºï¼Œè¿›å…¥ä¸‹ä¸€æ­¥æ¨é€ã€‚"

      - name: 4. åŒæ­¥ç»“æœå›ä»“åº“
        run: |
          if [ -s "output/all.yaml" ]; then
            cp -f output/all.yaml ./all.yaml
            git config --global user.email "bot@github.com"
            git config --global user.name "AutoBot"
            git add all.yaml
            git commit -m "ğŸš€ è‡ªåŠ¨åŒæ­¥èŠ‚ç‚¹: $(date +'%Y-%m-%d %H:%M')" || true
            git push origin HEAD:${{ github.ref_name }}
            echo "âœ… ä»“åº“åŒæ­¥æˆåŠŸï¼"
          else
            echo "âš ï¸ æœªå‘ç°æœ‰æ•ˆè¾“å‡ºæ–‡ä»¶ï¼Œè·³è¿‡åŒæ­¥ã€‚"
          fi

      - name: 5. æŒ‚æœºé”å®š (30 åˆ†é’Ÿ)
        run: |
          echo "ğŸ”— å‰ç«¯åœ°å€: https://sub-store.vercel.app?api=${{ env.TUNNEL_URL }}"
          echo "â³ åŒæ­¥å·²å®Œæˆï¼Œéš§é“å°†ç»§ç»­ä¿æŒ 30 åˆ†é’Ÿã€‚å¦‚æœä¸éœ€è¦ï¼Œè¯·æ‰‹åŠ¨åœæ­¢ä»»åŠ¡ã€‚"
          sleep 1800
