name: Sub-Store Real-Time Perfect25
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: 2. å‡†å¤‡ç¯å¢ƒä¸éš§é“
        run: |
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          # å¯åŠ¨éš§é“
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel.log > /dev/null 2>&1 &

      - name: 3. æ‰§è¡Œæ£€æµ‹å¹¶æŒ‚æœº
        run: |
          # å¯åŠ¨å®¹å™¨
          docker run --name sub-backend -d \
            -p 8299:8299 \
            -v ${{ github.workspace }}/config/config.yaml:/app/config/config.yaml \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master

          sleep 10
          API_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
          echo -e "\n------------------------------------------------"
          echo "ğŸŒ å®˜æ–¹å‰ç«¯: https://sub-store.vercel.app?api=$API_URL"
          echo -e "------------------------------------------------\n"

          # ã€å“¨å…µã€‘åœ¨åå°ç›¯ç€æ—¥å¿—ï¼Œæ£€æµ‹åˆ°å®Œæˆå°±æ¨é€
          (
            while true; do
              # åŒ¹é…â€œä¸‹æ¬¡æ£€æŸ¥æ—¶é—´â€ï¼Œè¿™æ˜¯æ£€æµ‹å½»åº•ç»“æŸçš„æ ‡å¿—
              if docker logs sub-backend 2>&1 | grep -q "ä¸‹æ¬¡æ£€æŸ¥æ—¶é—´"; then
                echo "ğŸ¯ [å“¨å…µ] ç›‘æµ‹åˆ°æ£€æµ‹ç»“æŸï¼Œå¼€å§‹åŒæ­¥ä»“åº“..."
                sleep 2
                if [ -s "output/all.yaml" ]; then
                  cp -f output/all.yaml ./all.yaml
                  git config --global user.email "bot@github.com"
                  git config --global user.name "AutoBot"
                  git add all.yaml
                  git commit -m "ğŸš€ è‡ªåŠ¨åŒæ­¥: $(date +'%Y-%m-%d %H:%M')" || true
                  git push origin HEAD:${{ github.ref_name }}
                  echo "âœ… [å“¨å…µ] ä»“åº“åŒæ­¥åœ†æ»¡å®Œæˆï¼"
                fi
                break # åŒæ­¥å®Œå“¨å…µå°±é€€å‡º
              fi
              sleep 5
            done
          ) &

          # ã€ä¸»è¿›ç¨‹ã€‘å‰å°å®æ—¶æ˜¾ç¤ºæ—¥å¿—ï¼Œç›´åˆ°å®¹å™¨åœæ­¢æˆ–æ‰‹åŠ¨å–æ¶ˆ
          # ä½¿ç”¨ tail -f é…åˆ docker logs èƒ½å¤Ÿæœ€å¿«åœ°åˆ·æ–°è¿›åº¦æ¡
          docker logs -f sub-backend &
          
          # ã€æŒ‚æœºé”ã€‘å‰å°ç­‰å¾…ï¼Œé˜²æ­¢ Action è‡ªåŠ¨å–æ¶ˆ
          echo "â³ ç³»ç»Ÿå·²è¿›å…¥æŒ‚æœºæ¨¡å¼ï¼Œéš§é“æŒç»­æœ‰æ•ˆï¼ˆé™æ—¶ 60 åˆ†é’Ÿï¼‰..."
          # ä½¿ç”¨ read å‘½ä»¤é˜»å¡å‰å°ï¼Œè¿™æ¯” for å¾ªç¯æ›´ç¨³
          sleep 3600
