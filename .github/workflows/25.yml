name: Sub-Store One-Time Check 25
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: 2. å‡†å¤‡ç¯å¢ƒä¸éš§é“
        run: |
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output
          
          # å¯åŠ¨éš§é“
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel.log > /dev/null 2>&1 &

      - name: 3. æ‰§è¡Œå•æ¬¡æ£€æµ‹ (å®æ—¶æ˜¾ç¤ºè¿‡ç¨‹)
        run: |
          echo "ğŸš€ å¯åŠ¨å®¹å™¨å¹¶å¼€å§‹æ£€æµ‹..."
          
          # å¯åŠ¨å®¹å™¨ (åå°è¿è¡Œ)
          docker run --name sub-backend -d \
            -p 8299:8299 \
            -v ${{ github.workspace }}/config/config.yaml:/app/config/config.yaml \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master

          # ç­‰å¾…åŸŸååˆ†é…
          sleep 10
          API_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
          echo -e "\n------------------------------------------------"
          echo "ğŸŒ å®˜æ–¹å‰ç«¯: https://sub-store.vercel.app?api=$API_URL"
          echo -e "------------------------------------------------\n"

          # ã€æ ¸å¿ƒé€»è¾‘ã€‘å®æ—¶è¿½è¸ªæ—¥å¿—ï¼Œç›´åˆ°å‘ç°â€œæ£€æµ‹å®Œæˆâ€
          docker logs -f sub-backend | while read line; do
            echo "$line" # è¾“å‡ºåˆ°æ§åˆ¶å°è®©ä½ çœ‹è¿›åº¦
            if [[ "$line" == *"æ£€æµ‹å®Œæˆ"* ]]; then
              echo "ğŸ¯ æ•è·åˆ°å®Œæˆä¿¡å·ï¼Œå‡†å¤‡æ”¶å·¥ï¼"
              # æ€æ‰å®¹å™¨ï¼Œè¿™ä¼šæ‰“ç ´ docker logs -f çš„é˜»å¡ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥
              docker stop sub-backend
              break
            fi
          done

      - name: 4. åŒæ­¥ç»“æœå¹¶å½»åº•å…³é—­
        run: |
          echo "ğŸ“¦ æ­£åœ¨å°†æ£€æµ‹åˆ°çš„ 49 ä¸ªèŠ‚ç‚¹å­˜å…¥ä»“åº“..."
          
          if [ -s "output/all.yaml" ]; then
            cp -f output/all.yaml ./all.yaml
            git config --global user.email "bot@github.com"
            git config --global user.name "AutoBot"
            git add all.yaml
            git commit -m "ğŸš€ è‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹: $(date +'%Y-%m-%d %H:%M')" || exit 0
            git push origin HEAD:${{ github.ref_name }}
            echo "âœ… all.yaml åŒæ­¥æˆåŠŸï¼"
          else
            echo "âŒ æœªå‘ç° output/all.yamlï¼Œæ£€æµ‹å¯èƒ½å¤±è´¥ã€‚"
            exit 1
          fi
