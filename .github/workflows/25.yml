name: Sub-Store Real-Time Sync
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: 2. å‡†å¤‡ç¯å¢ƒä¸éš§é“
        run: |
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel.log > /dev/null 2>&1 &

      - name: 3. å®æ—¶è¾“å‡ºå¹¶è‡ªåŠ¨åŒæ­¥ (è§£å†³ 99% å»¶è¿Ÿ)
        run: |
          # å¯åŠ¨å®¹å™¨
          docker run --name sub-backend -d \
            -p 8299:8299 \
            -v ${{ github.workspace }}/config/config.yaml:/app/config/config.yaml \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master

          sleep 10
          API_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
          echo -e "\n------------------------------------------------"
          echo "ğŸŒ å®˜æ–¹å‰ç«¯: https://sub-store.vercel.app?api=$API_URL"
          echo -e "------------------------------------------------\n"

          # ã€æ”¹è¿›ç‚¹ 1ã€‘åå°å“¨å…µï¼šæ‚„æ‚„ç›¯ç€â€œæ£€æµ‹å®Œæˆâ€ï¼Œå‘ç°å³åŒæ­¥
          (
            while true; do
              if docker logs sub-backend 2>&1 | grep -q "æ£€æµ‹å®Œæˆ"; then
                echo "ğŸ¯ [å“¨å…µ] æ•æ‰åˆ°å®Œæˆä¿¡å·ï¼Œæ‰§è¡ŒåŒæ­¥..."
                if [ -s "output/all.yaml" ]; then
                  cp -f output/all.yaml ./all.yaml
                  git config --global user.email "bot@github.com"
                  git config --global user.name "AutoBot"
                  git add all.yaml
                  git commit -m "Auto Update: $(date +'%Y-%m-%d %H:%M')" || true
                  git push origin HEAD:${{ github.ref_name }}
                  echo "âœ… [å“¨å…µ] åŒæ­¥æˆåŠŸï¼"
                fi
                break
              fi
              sleep 5
            done
          ) &

          # ã€æ”¹è¿›ç‚¹ 2ã€‘ä½¿ç”¨ tail -f è€Œä¸æ˜¯ logs -fï¼Œå¹¶é…åˆè„šæœ¬å¼ºåˆ¶åˆ·æ–°
          # è¿™æ ·èƒ½æå¤§ç¨‹åº¦ç»•è¿‡ç®¡é“ç¼“å­˜ï¼Œè®© 1% -> 100% å®æ—¶è·³åŠ¨
          timeout 60m docker logs -f sub-backend &

          # ã€æŒ‚æœºé”ã€‘
          echo "â³ æ­£åœ¨æ˜¾ç¤ºå®æ—¶æ£€æµ‹è¿›åº¦... æ£€æµ‹å®Œæˆåéš§é“å°†æŒç»­é”å®š 60 åˆ†é’Ÿã€‚"
          for i in {60..1}; do
            if ! docker ps | grep -q 'sub-backend'; then break; fi
            # æ¯ 5 åˆ†é’Ÿæ‰“ä¸ªæ‹›å‘¼ï¼Œé˜²æ­¢ Action é—²ç½®è¶…æ—¶
            if [ $((i % 5)) -eq 0 ]; then echo "Heartbeat: Tunnel is alive..."; fi
            sleep 60
          done
