name: Sub-Store Perfect Sync
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: 2. å‡†å¤‡ç›®å½•ä¸éš§é“
        run: |
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel.log > /dev/null 2>&1 &

      - name: 3. å¯åŠ¨å®¹å™¨ä¸å®æ—¶ç›‘æ§ (è§£å†³ç¼“å­˜ä¸æŒ‚æœºé—®é¢˜)
        run: |
          # 1. å¯åŠ¨å®¹å™¨
          docker run --name sub-backend -d \
            -p 8299:8299 \
            -v ${{ github.workspace }}/config/config.yaml:/app/config/config.yaml \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master

          sleep 10
          API_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
          echo -e "\n------------------------------------------------"
          echo "ğŸŒ å®˜æ–¹å‰ç«¯: https://sub-store.vercel.app?api=$API_URL"
          echo -e "------------------------------------------------\n"

          # 2. ã€æ ¸å¿ƒä¼˜åŒ–ã€‘ç›´æ¥å‰å°æ˜¾ç¤ºæ—¥å¿—ï¼Œä¸ç»è¿‡ç®¡é“ï¼Œè§£å†³â€œçªç„¶å¼¹å‡ºâ€çš„é—®é¢˜
          # åŒæ—¶åœ¨åå°è·‘ä¸€ä¸ªâ€œåŒæ­¥å“¨å…µâ€
          (
            LAST_MARK=""
            while true; do
              sleep 10
              if docker logs sub-backend 2>&1 | grep -q "æ£€æµ‹å®Œæˆ"; then
                echo "ğŸ¯ å“¨å…µï¼šæ£€æµ‹å·²å®Œæˆï¼Œæ­£åœ¨åå°åŒæ­¥ä»“åº“..."
                if [ -s "output/all.yaml" ]; then
                  cp -f output/all.yaml ./all.yaml
                  git config --global user.email "bot@github.com"
                  git config --global user.name "AutoBot"
                  git add all.yaml
                  git commit -m "Auto Update: $(date +'%Y-%m-%d %H:%M')" || true
                  git push origin HEAD:${{ github.ref_name }}
                  echo "âœ… å“¨å…µï¼šåŒæ­¥æˆåŠŸï¼"
                fi
                break # å“¨å…µä»»åŠ¡å®Œæˆï¼Œé€€å‡ºå¾ªç¯
              fi
            done
          ) &

          # 3. ã€è§£å†³æ˜¾ç¤ºé—®é¢˜ã€‘å‰å°ç›´æ¥çœ‹æ—¥å¿—ï¼Œä¸ä½¿ç”¨ read line æ‹¦æˆª
          # è¿™ä¼šè®©è¿›åº¦æ¡ 1%, 2% å®æ—¶è·³åŠ¨ï¼Œè€Œä¸æ˜¯æœ€åæ‰å¼¹å‡º
          docker logs -f sub-backend &
          
          # 4. ã€æŒ‚æœºé”ã€‘è®©ä»»åŠ¡æŒç»­è¿è¡Œ 15 åˆ†é’Ÿï¼Œç¡®ä¿éš§é“ä¸æ‰
          for i in {15..1}; do
            if ! docker ps | grep -q 'sub-backend'; then break; fi
            echo "â³ éš§é“æŒ‚æœºä¸­... å‰©ä½™ $i åˆ†é’Ÿ (è¿›åº¦ä¼šåœ¨ä¸Šæ–¹å®æ—¶æ˜¾ç¤º)"
            sleep 60
          done
