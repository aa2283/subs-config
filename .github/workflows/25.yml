name: Sub-Store Anti-Freeze
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: 2. å‡†å¤‡éš§é“ (åå°é™é»˜)
        run: |
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel.log > /dev/null 2>&1 &
          sleep 5
          API_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
          echo "TUNNEL_URL=$API_URL" >> $GITHUB_ENV
          echo "### ğŸŒ å®˜æ–¹å‰ç«¯åœ°å€: https://sub-store.vercel.app?api=$API_URL" >> $GITHUB_STEP_SUMMARY

      - name: 3. æ‰§è¡Œæ£€æµ‹ (å®æ—¶è¿›åº¦)
        run: |
          docker run --name sub-backend -d \
            -p 8299:8299 \
            -v ${{ github.workspace }}/config/config.yaml:/app/config/config.yaml \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master

          echo "ğŸš€ æ­£åœ¨æ£€æµ‹ï¼Œè¯·è§‚å¯Ÿä¸‹æ–¹å®æ—¶è¿›åº¦..."
          # ä½¿ç”¨ timeout ç›‘æ§ï¼Œä¸€æ—¦å‘ç°â€œä¸‹æ¬¡æ£€æŸ¥æ—¶é—´â€å°±ç»“æŸè¿™ä¸€æ­¥
          docker logs -f sub-backend | sed '/ä¸‹æ¬¡æ£€æŸ¥æ—¶é—´/q'
          echo "ğŸ¯ æ£€æµ‹å·²å®Œæˆï¼"

      - name: 4. åŒæ­¥ç»“æœ (æˆåŠŸæ ‡å¿—)
        run: |
          if [ -s "output/all.yaml" ]; then
            cp -f output/all.yaml ./all.yaml
            git config --global user.email "bot@github.com"
            git config --global user.name "AutoBot"
            git add all.yaml
            git commit -m "ğŸš€ è‡ªåŠ¨åŒæ­¥: $(date +'%Y-%m-%d %H:%M')" || true
            git push origin HEAD:${{ github.ref_name }}
            echo "âœ… ç»“æœå·²åŒæ­¥å›ä»“åº“ï¼Œæ–‡ä»¶å·²æ°¸ä¹…ä¿å­˜ã€‚"
          fi

      - name: 5. å¼€å¯æŒ‚æœºæ¨¡å¼ (æŒ‰éœ€ä¿æŒéš§é“)
        run: |
          echo "------------------------------------------------"
          echo "ğŸ”— å‰ç«¯é“¾æ¥: https://sub-store.vercel.app?api=${{ env.TUNNEL_URL }}"
          echo "------------------------------------------------"
          echo "â³ ä»»åŠ¡å·²å®ŒæˆåŒæ­¥ï¼Œç°åœ¨è¿›å…¥ 60 åˆ†é’ŸæŒ‚æœºé”å®šçŠ¶æ€..."
          echo "ğŸ’¡ å¦‚æœä½ ä¸éœ€è¦ä½¿ç”¨ç½‘é¡µç«¯ï¼Œå¯ä»¥ç›´æ¥ç‚¹å‡»å³ä¸Šè§’ 'Cancel workflow' ç»“æŸã€‚"
          sleep 3600
