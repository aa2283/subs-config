name: Sub-Store Integrated Sync-125å¾…æˆåŠŸ-å¸¦é…ç½®å¤‡ä»½
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: 2. ç¯å¢ƒä¸éš§é“å‡†å¤‡ (å®‰å…¨åŠ å¯†ç‰ˆ)
        run: |
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output
          
          # ä¸‹è½½å¹¶é™é»˜å¯åŠ¨éš§é“
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel.log > /dev/null 2>&1 &
          
          echo "â³ æ­£åœ¨å»ºç«‹ç§å¯†è¿æ¥å¹¶åŒæ­¥è‡³å›ºå®šåŸŸå..."
          for i in {1..30}; do
            # 1. æå–åŸŸåä½†ä¸æ‰“å°åˆ°æ—¥å¿—
            TEMP_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
            
            if [ -n "$TEMP_URL" ]; then
              # 2. ğŸš€ ä½¿ç”¨ Secrets å®‰å…¨åœ°åŒæ­¥åˆ° CF KVï¼Œä¸”ä¸è¾“å‡º curl çš„ä»»ä½•æ—¥å¿—
              curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_KV_ID }}/values/TARGET_API" \
                   -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
                   -d "$TEMP_URL" > /dev/null
              
              # 3. å°†å˜é‡å­˜å…¥ GITHUB_ENV ä¾›åç»­æ­¥éª¤å†…éƒ¨ä½¿ç”¨
              echo "TUNNEL_URL=$TEMP_URL" >> $GITHUB_ENV
              
              echo "âœ… å›ºå®šåŸŸåå·²å°±ç»ªï¼æ‚¨å¯ç›´æ¥é€šè¿‡CTå®˜æ–¹åˆ†é…çš„åŸŸåæˆ–è‡ªå®šä¹‰åŸŸåè®¿é—®ã€‚"
              echo "### ğŸŒ è®¿é—®åœ°å€å·²æ›´æ–°è‡³å›ºå®šåŸŸå" >> $GITHUB_STEP_SUMMARY
              break
            fi
            sleep 1
          done

          if [ -z "$TEMP_URL" ]; then echo "âŒ éš§é“å¯åŠ¨è¶…æ—¶"; exit 1; fi

      - name: 3. æ‰§è¡Œä½ çš„æ£€æµ‹è„šæœ¬ (å®æ—¶è¿›åº¦+å“¨å…µ)
        run: |

          # ã€æ–°å¢ã€‘å…³é”®æ­¥éª¤ï¼šåœ¨å®¹å™¨å¯åŠ¨å‰ï¼ŒæŠŠä»“åº“é‡Œçš„æ—§é…ç½®å¡è¿›æŒ‚è½½ç›®å½•
          echo "ğŸ“‚ æ­£åœ¨é¢„è£…è½½ç°æœ‰é…ç½®..."
          [ -f "sub-store.json" ] && cp -f sub-store.json ${{ github.workspace }}/output/sub-store.json || echo "é¦–æ¬¡è¿è¡Œï¼Œæ— å¤‡ä»½é…ç½®"
          [ -f "all.yaml" ] && cp -f all.yaml ${{ github.workspace }}/output/all.yaml || true
          
          # ç»™äºˆæƒé™ç¡®ä¿å®¹å™¨å¯å†™
          sudo chmod -R 777 ${{ github.workspace }}/output
          
          (
            echo ">>> [å“¨å…µ] å¯åŠ¨æˆåŠŸ..."
            HUNDRED_TIME=0
            while true; do
              sleep 10
              if ! docker ps | grep -q 'checker'; then break; fi
              LOGS=$(docker logs --tail 20 checker 2>&1 | sed 's/\x1b\[[0-9;]*m//g')
              
              if echo "$LOGS" | grep -qE "ä¿å­˜æœ¬åœ°æˆåŠŸ|èŠ‚ç‚¹ä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜"; then
                echo ">>> [å“¨å…µæŠ¥å‘Š] ä»»åŠ¡å®Œæˆï¼æ‰§è¡Œå¼ºåˆ¶æ”¶å‰²..."
                docker kill checker || true
                break
              fi
              
              if echo "$LOGS" | grep -q "100.0%"; then
                HUNDRED_TIME=$((HUNDRED_TIME + 10))
                if [ $HUNDRED_TIME -ge 120 ]; then
                  docker kill checker || true
                  break
                fi
              else
                HUNDRED_TIME=0
              fi
            done
          ) &

          echo "ğŸš€ å¯åŠ¨å®¹å™¨ï¼ŒæŒ‚è½½å·²åŒ…å«æ—§é…ç½®ï¼Œè¿›åº¦å°†å®æ—¶æ˜¾ç¤º..."
          docker run --name checker --rm -t \
            -p 8299:8299 \
            -v ${{ github.workspace }}/config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master || [ $? -eq 137 ] || [ $? -eq 143 ]

      - name: 4. åŒæ­¥ç»“æœå›ä»“åº“ (èŠ‚ç‚¹+é…ç½®)
        run: |
          git config --global user.email "bot@github.com"
          git config --global user.name "AutoBot"
          
          # åŒæ—¶å¤‡ä»½ all.yaml å’Œ sub-store.json
          [ -s "output/all.yaml" ] && cp -f output/all.yaml ./all.yaml || true
          [ -f "output/sub-store.json" ] && cp -f output/sub-store.json ./sub-store.json || true
          
          git add all.yaml sub-store.json
          git commit -m "ğŸš€ è‡ªåŠ¨åŒæ­¥ (èŠ‚ç‚¹+é…ç½®): $(date +'%H:%M')" || true
          git push origin HEAD:${{ github.ref_name }}

      - name: 5. æŒ‚æœºé”å®š (15åˆ†é’Ÿå®æ—¶åŒæ­¥ç½‘é¡µä¿®æ”¹)
        run: |
          docker rm -f checker >/dev/null 2>&1 || true
          docker run --name checker -d -p 8299:8299 \
            -v ${{ github.workspace }}/config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master >/dev/null

          # ã€é™é»˜ç‰ˆã€‘å®æ—¶åŒæ­¥å“¨å…µ
          (
            while true; do
              sleep 30
              # å…ˆæŠŠå®¹å™¨é‡Œçš„æœ€æ–°é…ç½®åŒæ­¥å‡ºæ¥
              cp -f output/sub-store.json ./sub-store.json || true
              cp -f output/all.yaml ./all.yaml || true
              
              # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŠ¨ï¼Œå¦‚æœæœ‰ï¼Œ porcelain ä¼šè¾“å‡ºå†…å®¹ï¼Œå¦åˆ™ä¸ºç©º
              CHANGES=$(git status --porcelain all.yaml sub-store.json)
              
              if [ -n "$CHANGES" ]; then
                echo "ğŸ“¢ [å®æ—¶åŒæ­¥] æ£€æµ‹åˆ°ç½‘é¡µç«¯æ”¹åŠ¨ï¼Œæ­£åœ¨æ¨é€..."
                git config --global user.email "bot@github.com"
                git config --global user.name "AutoBot"
                git add all.yaml sub-store.json
                git commit -m "ğŸ“ ç½‘é¡µç«¯å®æ—¶åŒæ­¥: $(date +'%H:%M')" && git push || true
                echo "âœ… [å®æ—¶åŒæ­¥] å·²å…¥åº“ã€‚"
              fi
              # å¦‚æœæ²¡æœ‰ CHANGESï¼Œå°±ä»€ä¹ˆéƒ½ä¸æ‰“å°ï¼Œä¿æŒæ—¥å¿—æ¸…çˆ½
            done
          ) &

          for i in {15..1}; do
            echo "â³ è·ç¦»éš§é“è‡ªåŠ¨å…³é—­è¿˜å‰©: $i åˆ†é’Ÿ (å®æ—¶åŒæ­¥ä¸­)"
            sleep 60
          done
