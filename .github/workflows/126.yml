
name: Sub-Store Integrated Sync-125å¾…æˆåŠŸ-å¸¦é…ç½®å¤‡ä»½
on:
  schedule:
    - cron: '15 4 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: 2. ç¯å¢ƒä¸éš§é“å‡†å¤‡ (å®‰å…¨åŠ å¯†ç‰ˆ)
        run: |
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output
          
          # ä¸‹è½½å¹¶é™é»˜å¯åŠ¨éš§é“
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel.log > /dev/null 2>&1 &Â  
          
          echo "â³ æ­£åœ¨å»ºç«‹ç§å¯†è¿æ¥å¹¶åŒæ­¥è‡³å›ºå®šåŸŸå..."
          for i in {1..30}; do
            # 1. æå–åŸŸåä½†ä¸æ‰“å°åˆ°æ—¥å¿—
            TEMP_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
            
            if [ -n "$TEMP_URL" ]; then
              # 2. ğŸš€ ä½¿ç”¨ Secrets å®‰å…¨åœ°åŒæ­¥åˆ° CF KVï¼Œä¸”ä¸è¾“å‡º curl çš„ä»»ä½•æ—¥å¿—
              curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_KV_ID }}/values/TARGET_API" \
                   -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
                   -d "$TEMP_URL" > /dev/null
              
              # 3. å°†å˜é‡å­˜å…¥ GITHUB_ENV ä¾›åç»­æ­¥éª¤å†…éƒ¨ä½¿ç”¨
              echo "TUNNEL_URL=$TEMP_URL" >> $GITHUB_ENV
              
              echo "âœ… å›ºå®šåŸŸåå·²å°±ç»ªï¼æ‚¨å¯ç›´æ¥é€šè¿‡CTå®˜æ–¹åˆ†é…çš„åŸŸåæˆ–è‡ªå®šä¹‰åŸŸåè®¿é—®ã€‚"
              echo "### ğŸŒ è®¿é—®åœ°å€å·²æ›´æ–°è‡³å›ºå®šåŸŸå" >> $GITHUB_STEP_SUMMARY
              break
            fi
            sleep 1
          done

          if [ -z "$TEMP_URL" ]; then echo "âŒ éš§é“å¯åŠ¨è¶…æ—¶"; exit 1; fi

      - name: 3. æ‰§è¡Œä½ çš„æ£€æµ‹è„šæœ¬ (å®æ—¶è¿›åº¦+å“¨å…µ)
        run: |

          mkdir -p ${{ github.workspace }}/output
          
          echo "ğŸ“¥ æ­£åœ¨ä» KV æ¢å¤é…ç½®..."
          # ä» KV è·å–æ•°æ®å¹¶å†™å…¥æ–‡ä»¶
          RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_KV_ID }}/values/SUB_STORE_CONFIG" \
               -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}")
          
          # ç®€å•æ ¡éªŒï¼šå¦‚æœ KV æ˜¯ç©ºçš„æˆ–è€…æŠ¥é”™ï¼Œä¸è¦†ç›–æœ¬åœ°ï¼Œé˜²æ­¢æ´—æ‰æ•°æ®
          if [ -n "$RESPONSE" ] && [[ "$RESPONSE" != *"error"* ]]; then
            echo "$RESPONSE" > ${{ github.workspace }}/output/sub-store.json
            echo "âœ… é…ç½®æ¢å¤æˆåŠŸ"
          else
            echo "âš ï¸ KV ä¸ºç©ºæˆ–è¯»å–å¤±è´¥ï¼Œå°†ä½¿ç”¨åˆå§‹é…ç½®"
          fi
          
          sudo chmod -R 777 ${{ github.workspace }}/output

          # ã€æ–°å¢ã€‘å…³é”®æ­¥éª¤ï¼šåœ¨å®¹å™¨å¯åŠ¨å‰ï¼ŒæŠŠä»“åº“é‡Œçš„æ—§é…ç½®å¡è¿›æŒ‚è½½ç›®å½•
          #echo "ğŸ“‚ æ­£åœ¨é¢„è£…è½½ç°æœ‰é…ç½®..."
          #[ -f "sub-store.json" ] && cp -f sub-store.json ${{ github.workspace }}/output/sub-store.json || echo "é¦–æ¬¡è¿è¡Œï¼Œæ— å¤‡ä»½é…ç½®"
          #[ -f "all.yaml" ] && cp -f all.yaml ${{ github.workspace }}/output/all.yaml || true
          
          # ç»™äºˆæƒé™ç¡®ä¿å®¹å™¨å¯å†™
          #sudo chmod -R 777 ${{ github.workspace }}/output
          
          (
            echo ">>> [å“¨å…µ] å¯åŠ¨æˆåŠŸ..."
            HUNDRED_TIME=0
            while true; do
              sleep 10
              if ! docker ps | grep -q 'checker'; then break; fi
              LOGS=$(docker logs --tail 20 checker 2>&1 | sed 's/\x1b\[[0-9;]*m//g')
              
              if echo "$LOGS" | grep -qE "ä¿å­˜æœ¬åœ°æˆåŠŸ|èŠ‚ç‚¹ä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜"; then
                echo ">>> [å“¨å…µæŠ¥å‘Š] ä»»åŠ¡å®Œæˆï¼æ‰§è¡Œå¼ºåˆ¶æ”¶å‰²..."
                docker kill checker || true
                break
              fi
              
              if echo "$LOGS" | grep -q "100.0%"; then
                HUNDRED_TIME=$((HUNDRED_TIME + 10))
                if [ $HUNDRED_TIME -ge 120 ]; then
                  docker kill checker || true
                  break
                fi
              else
                HUNDRED_TIME=0
              fi
            done
          ) &

          echo "ğŸš€ å¯åŠ¨å®¹å™¨ï¼ŒæŒ‚è½½å·²åŒ…å«æ—§é…ç½®ï¼Œè¿›åº¦å°†å®æ—¶æ˜¾ç¤º..."
          docker run --name checker --rm -t \
            -p 8299:8299 \
            -v ${{ github.workspace }}/config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master || [ $? -eq 137 ] || [ $? -eq 143 ]

      - name: 4. åŒæ­¥ç»“æœå›ä»“åº“ (èŠ‚ç‚¹+é…ç½®)
        run: |

          if [ -f "output/sub-store.json" ]; then
            echo "ğŸ“¤ æ­£åœ¨å¤‡ä»½æœ€æ–°é…ç½®åˆ° KV..."
            curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_KV_ID }}/values/SUB_STORE_CONFIG" \
                 -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
                 --data-binary @output/sub-store.json > /dev/null
            echo "âœ… å¤‡ä»½å®Œæˆ"
          fi
          
          #git config --global user.email "bot@github.com"
          #git config --global user.name "AutoBot"
          
          # åŒæ—¶å¤‡ä»½ all.yaml å’Œ sub-store.json
          #[ -s "output/all.yaml" ] && cp -f output/all.yaml ./all.yaml || true
          #[ -f "output/sub-store.json" ] && cp -f output/sub-store.json ./sub-store.json || true
          
          #git add all.yaml sub-store.json
          #git commit -m "ğŸš€ è‡ªåŠ¨åŒæ­¥ (èŠ‚ç‚¹+é…ç½®): $(date +'%H:%M')" || true
          #git push origin HEAD:${{ github.ref_name }}

      - name: 5. æŒ‚æœºé”å®š (15åˆ†é’Ÿå®æ—¶åŒæ­¥ç½‘é¡µä¿®æ”¹)
        run: |
          docker rm -f checker >/dev/null 2>&1 || true
          docker run --name checker -d -p 8299:8299 \
            -v ${{ github.workspace }}/config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master >/dev/null

          # ã€é™é»˜ç‰ˆã€‘å®æ—¶åŒæ­¥å“¨å…µ
          (
            while true; do
              sleep 30

              
              # å…ˆæŠŠå®¹å™¨é‡Œçš„æœ€æ–°é…ç½®åŒæ­¥å‡ºæ¥
              cp -f output/sub-store.json ./sub-store.json || true
              cp -f output/all.yaml ./all.yaml || true
              
              # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŠ¨ï¼Œå¦‚æœæœ‰ï¼Œ porcelain ä¼šè¾“å‡ºå†…å®¹ï¼Œå¦åˆ™ä¸ºç©º
              CHANGES=$(git status --porcelain all.yaml sub-store.json)
              
              if [ -n "$CHANGES" ]; then  
              echo "ğŸ“¢ æ£€æµ‹åˆ°ç½‘é¡µä¿®æ”¹ï¼Œå®æ—¶ä¸Šä¼  KV..."
              curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_KV_ID }}/values/SUB_STORE_CONFIG" \
              -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
              --data-binary @output/sub-store.json > /dev/null
              echo "âœ… KVå¤‡ä»½å®Œæˆ"
              fi
                
              # 1. è‡ªåŠ¨ä»å˜é‡è¯»å–æ¸…å• (è‹¥å˜é‡ä¸å­˜åœ¨åˆ™æŠ“å– zh:ClashMeta ä½œä¸ºå¤‡ä»½)
          # ä½ åœ¨ GitHub Variables é‡Œä¿®æ”¹ SUB_LIST å³å¯ç”Ÿæ•ˆ
          LIST="${{ vars.SUB_LIST || 'zh:ClashMeta' }}"
          
          # 2. ç¯å¢ƒåˆå§‹åŒ–
          echo "ğŸ“‚ æ­£åœ¨å…‹éš†ç§æœ‰åº“: aa2283/v2ray_configs"
          git clone https://${{ secrets.MY_PAT }}@github.com/aa2283/v2ray_configs.git backup_repo
          mkdir -p backup_repo/sub_config/
          
          # 3. è¿›å…¥å¾ªç¯ï¼šå¤„ç†æ¯ä¸€ä¸ªè®¢é˜…é¡¹
          # ä½¿ç”¨ IFS å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„
          IFS=',' read -ra ITEMS <<< "$LIST"
          for item in "${ITEMS[@]}"; do
            # æ‹†åˆ† åå­— å’Œ æ ¼å¼ (ä¾‹å¦‚ name:type)
            NAME="${item%%:*}"
            TYPE="${item##*:}"
            
            # è‡ªåŠ¨åˆ†é…åç¼€å
            if [[ "$TYPE" == *"Clash"* ]]; then
              EXT="yaml"
            else
              EXT="txt"
            fi
            
            echo "ğŸ“¥ æ­£åœ¨æ‹‰å–: $NAME ($TYPE) -> $NAME.$EXT"
            
            # æ‰§è¡Œä¸‹è½½å‘½ä»¤ (127.0.0.1 è®¿é—®å®¹å™¨)
            curl -s "http://127.0.0.1:8299/download/${NAME}?target=${TYPE}" \
                 -o "backup_repo/sub_config/${NAME}.${EXT}"
          done

          # 4. æäº¤å›ç§æœ‰ä»“åº“
          cd backup_repo
          git config --global user.email "bot@github.com"
          git config --global user.name "AutoBot"
          git add sub_config/
          
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸš€ æ£€æµ‹åˆ°è®¢é˜…æ›´æ–°ï¼Œæ¨é€åˆ°ç§æœ‰ä»“åº“..."
            git commit -m "ğŸ”– è‡ªåŠ¨åŒæ­¥: $(date +'%H:%M') [æ¸…å•: $LIST]"
            git push origin main
          else
            echo "âœ¨ è®¢é˜…å†…å®¹æ— å˜åŠ¨ï¼Œè·³è¿‡æ¨é€ã€‚"
          fi
              
              # å¦‚æœæ²¡æœ‰ CHANGESï¼Œå°±ä»€ä¹ˆéƒ½ä¸æ‰“å°ï¼Œä¿æŒæ—¥å¿—æ¸…çˆ½
            done
          ) &

          for i in {15..1}; do
            echo "â³ è·ç¦»éš§é“è‡ªåŠ¨å…³é—­è¿˜å‰©: $i åˆ†é’Ÿ (å®æ—¶åŒæ­¥ä¸­)"
            sleep 60
          done
