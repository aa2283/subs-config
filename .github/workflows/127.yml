name: Sub-Store Integrated Sync

on:
  schedule:
    - cron: '15 4 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: 2. ç¯å¢ƒä¸éš§é“å‡†å¤‡
        run: |
          mkdir -p ${{ github.workspace }}/output
          mkdir -p ${{ github.workspace }}/temp_config
          sudo chmod -R 777 ${{ github.workspace }}/output
          
          # ä¸‹è½½å¹¶å¯åŠ¨éš§é“
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel.log > /dev/null 2>&1 &
          
          echo "â³ ç­‰å¾…éš§é“å»ºç«‹..."
          for i in {1..30}; do
            TEMP_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
            if [ -n "$TEMP_URL" ]; then
              curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_KV_ID }}/values/TARGET_API" \
                   -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" -d "$TEMP_URL" > /dev/null
              echo "TUNNEL_URL=$TEMP_URL" >> $GITHUB_ENV
              echo "âœ… éš§é“åœ°å€: $TEMP_URL"
              break
            fi
            sleep 1
          done

      - name: 3. åŠ¨æ€æ³¨å…¥è®¢é˜…å¹¶è¿è¡Œæ£€æµ‹
        run: |
          # A. ä» KV æ¢å¤ Sub-Store é…ç½®
          RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_KV_ID }}/values/SUB_STORE_CONFIG" \
               -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}")
          if [ -n "$RESPONSE" ] && [[ "$RESPONSE" != *"error"* ]]; then
            echo "$RESPONSE" > ${{ github.workspace }}/output/sub-store.json
          fi

          # B. Python æ³¨å…¥éšè—è®¢é˜… (å½»åº•ä¿®å¤ç‰ˆ)
          export GITHUB_WORKSPACE_DIR="${{ github.workspace }}"
          export RAW_URLS_DATA="${{ secrets.SUB_URLS }}"
          python3 << 'EOF'
import os
workspace = os.environ.get('GITHUB_WORKSPACE_DIR')
raw_data = os.environ.get('RAW_URLS_DATA', '')
template_path = os.path.join(workspace, 'config/config.yaml')
output_path = os.path.join(workspace, 'temp_config/config.yaml')
urls = [u.strip() for u in raw_data.split('\n') if len(u.strip()) > 10]
formatted = [f'  - "{u}"\n' for u in urls]
new_lines = ['show-useless-url: true\n']
with open(template_path, 'r', encoding='utf-8') as f:
    for line in f:
        if '{SUB_URLS}' in line: new_lines.extend(formatted)
        elif 'show-useless-url' in line: continue
        else: new_lines.append(line)
os.makedirs(os.path.dirname(output_path), exist_ok=True)
with open(output_path, 'w', encoding='utf-8') as f:
    f.writelines(new_lines)
EOF

          # C. å¯åŠ¨å“¨å…µå¹¶è¿è¡Œå®¹å™¨
          (
            while true; do
              sleep 10
              if ! docker ps | grep -q 'checker'; then break; fi
              LOGS=$(docker logs --tail 20 checker 2>&1 | sed 's/\x1b\[[0-9;]*m//g')
              if echo "$LOGS" | grep -qE "ä¿å­˜æœ¬åœ°æˆåŠŸ|èŠ‚ç‚¹ä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜"; then
                docker kill checker || true; break
              fi
            done
          ) &

          docker run --name checker --rm -t \
            -v ${{ github.workspace }}/temp_config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master || true

      - name: 4. æŒ‚æœºé”å®šä¸å•å‘ç§æœ‰åº“å¤‡ä»½
        run: |
          # å¯åŠ¨åç«¯ç”¨äºç½‘é¡µä¿®æ”¹
          docker run --name checker -d -p 8299:8299 \
            -v ${{ github.workspace }}/temp_config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master

          # å…‹éš†ç§æœ‰åº“
          rm -rf backup_repo
          git clone https://${{ secrets.PAT_TOKEN }}@github.com/aa2283/v2ray_configs.git backup_repo
          git config --global user.email "bot@github.com"
          git config --global user.name "AutoBot"
          cp -f output/sub-store.json ./snapshot.json

          # åŒæ­¥å“¨å…µ
          (
            while true; do
              sleep 30
              if ! diff -q output/sub-store.json ./snapshot.json >/dev/null 2>&1; then
                cp -f output/sub-store.json ./snapshot.json
                # åŒæ­¥åˆ° KV
                curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_KV_ID }}/values/SUB_STORE_CONFIG" \
                  -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" --data-binary @output/sub-store.json > /dev/null
                # å¤‡ä»½åˆ°ç§æœ‰åº“
                mkdir -p backup_repo/sub_config/
                cp -f output/sub-store.json backup_repo/sub_config/sub-store.json
                pushd backup_repo > /dev/null
                git add . && git commit -m "ğŸ”– ç½‘é¡µå¤‡ä»½: $(date +'%H:%M')" && git push origin main || git push origin master
                popd > /dev/null
              fi
            done
          ) &

          for i in {15..1}; do echo "â³ è¿è¡Œä¸­... å‰©ä½™ $i åˆ†é’Ÿ"; sleep 60; done
