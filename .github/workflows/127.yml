name: Sub-Store-Integrated-Sync127

on:
  schedule:
    - cron: '15 4 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: 2. æ³¨å…¥è®¢é˜…åœ°å€
        run: |
          mkdir -p ${{ github.workspace }}/output
          mkdir -p ${{ github.workspace }}/temp_config
          
          export GITHUB_WORKSPACE_DIR="${{ github.workspace }}"
          export RAW_URLS_DATA="${{ secrets.SUB_URLS }}"
          
          python3 << 'EOF'
import os
workspace = os.environ.get('GITHUB_WORKSPACE_DIR')
raw_data = os.environ.get('RAW_URLS_DATA', '')
template_path = os.path.join(workspace, 'config/config.yaml')
output_path = os.path.join(workspace, 'temp_config/config.yaml')
urls = [u.strip() for u in raw_data.split('\n') if len(u.strip()) > 10]
formatted = [f'  - "{u}"\n' for u in urls]
new_lines = ['show-useless-url: true\n']
if os.path.exists(template_path):
    with open(template_path, 'r', encoding='utf-8') as f:
        for line in f:
            if '{SUB_URLS}' in line: new_lines.extend(formatted)
            elif 'show-useless-url' in line: continue
            else: new_lines.append(line)
    os.makedirs(os.path.dirname(output_path), exist_ok=True)
    with open(output_path, 'w', encoding='utf-8') as f:
        f.writelines(new_lines)
EOF

      - name: 3. æ‰§è¡Œæ£€æµ‹ä¸æŒ‚æœº
        run: |
          # å¯åŠ¨å®¹å™¨
          docker run --name checker -d -p 8299:8299 \
            -v ${{ github.workspace }}/temp_config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master
          
          # å‡†å¤‡ç§æœ‰åº“å¤‡ä»½ (PAT_TOKEN)
          rm -rf backup_repo
          git clone https://${{ secrets.PAT_TOKEN }}@github.com/aa2283/v2ray_configs.git backup_repo
          
          git config --global user.email "bot@github.com"
          git config --global user.name "AutoBot"
          cp -f output/sub-store.json ./snapshot.json || touch ./snapshot.json

          # å¯åŠ¨å¼‚æ­¥åŒæ­¥å“¨å…µ
          (
            while true; do
              sleep 30
              if [ -f "output/sub-store.json" ] && ! diff -q output/sub-store.json ./snapshot.json >/dev/null 2>&1; then
                echo "ğŸ“¢ æ£€æµ‹åˆ°é…ç½®å˜åŠ¨ï¼ŒåŒæ­¥ä¸­..."
                cp -f output/sub-store.json ./snapshot.json
                # A. åŒæ­¥åˆ° KV
                curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_KV_ID }}/values/SUB_STORE_CONFIG" \
                  -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" --data-binary @output/sub-store.json > /dev/null
                # B. åŒæ­¥åˆ°ç§æœ‰åº“
                mkdir -p backup_repo/sub_config/
                cp -f output/sub-store.json backup_repo/sub_config/sub-store.json
                pushd backup_repo > /dev/null
                git add . && git commit -m "ğŸ”– å¤‡ä»½: $(date +'%H:%M')" && git push origin main || git push origin master
                popd > /dev/null
              fi
            done
          ) &

          # æŒ‚æœº 15 åˆ†é’Ÿ
          for i in {15..1}; do echo "â³ å‰©ä½™ $i åˆ†é’Ÿ"; sleep 60; done
