
name: Sub-Store Integrated Sync-127å¾…æˆåŠŸ-éšè—è®¢é˜…
on:
  schedule:
    - cron: '15 4 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-service:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: 2. ç¯å¢ƒä¸éš§é“å‡†å¤‡ (å®‰å…¨åŠ å¯†ç‰ˆ)
        run: |
          mkdir -p ${{ github.workspace }}/output
          sudo chmod -R 777 ${{ github.workspace }}/output

          
          
          # ä¸‹è½½å¹¶é™é»˜å¯åŠ¨éš§é“
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://127.0.0.1:8299 --logfile tunnel.log > /dev/null 2>&1 &
          
          echo "â³ æ­£åœ¨å»ºç«‹ç§å¯†è¿æ¥å¹¶åŒæ­¥è‡³å›ºå®šåŸŸå..."
          for i in {1..30}; do
            # 1. æå–åŸŸå
            TEMP_URL=$(grep -oE 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
            
            if [ -n "$TEMP_URL" ]; then
              # 2. åŒæ­¥åˆ° CF KV
              curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_KV_ID }}/values/TARGET_API" \
                   -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
                   -d "$TEMP_URL" > /dev/null
              
              # 3. å­˜å…¥ ENV
              echo "TUNNEL_URL=$TEMP_URL" >> $GITHUB_ENV
              
              echo "âœ… å›ºå®šåŸŸåå·²å°±ç»ªï¼"
              echo "### ğŸŒ è®¿é—®åœ°å€å·²æ›´æ–°è‡³å›ºå®šåŸŸå" >> $GITHUB_STEP_SUMMARY
              break
            fi
            sleep 1
          done

          if [ -z "$TEMP_URL" ]; then echo "âŒ éš§é“å¯åŠ¨è¶…æ—¶"; exit 1; fi

      - name: 3. æ‰§è¡Œä½ çš„æ£€æµ‹è„šæœ¬ (å®æ—¶è¿›åº¦+å“¨å…µ)
        run: |
          mkdir -p ${{ github.workspace }}/output
          mkdir -p ${{ github.workspace }}/temp_config
          sudo chmod -R 777 ${{ github.workspace }}/output

          echo "ğŸ“¥ æ­£åœ¨ä» KV æ¢å¤é…ç½®..."
          RESPONSE=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_KV_ID }}/values/SUB_STORE_CONFIG" \
               -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}")
          
          if [ -n "$RESPONSE" ] && [[ "$RESPONSE" != *"error"* ]]; then
            echo "$RESPONSE" > ${{ github.workspace }}/output/sub-store.json
            echo "âœ… é…ç½®æ¢å¤æˆåŠŸ"
          fi

          # --- ä¿®å¤åçš„ Python æ³¨å…¥é€»è¾‘ ---
          export RAW_URLS_DATA="${{ secrets.SUB_URLS }}"
          python3 << 'EOF'
import os
template_path = '${{ github.workspace }}/config/config.yaml'
output_path = '${{ github.workspace }}/temp_config/config.yaml'
# è·å– Secret ç¯å¢ƒéå†
raw_data = os.environ.get('RAW_URLS_DATA', '')
# è¿‡æ»¤å¹¶æ ¼å¼åŒ–é“¾æ¥
urls = [u.strip() for u in raw_data.split('\n') if len(u.strip()) > 10]
formatted = [f'  - "{u}"\n' for u in urls]

new_lines = ['show-useless-url: true\n']
with open(template_path, 'r', encoding='utf-8') as f:
    for line in f:
        if '{SUB_URLS}' in line:
            new_lines.extend(formatted)
        elif 'show-useless-url' in line:
            continue
        else:
            new_lines.append(line)

with open(output_path, 'w', encoding='utf-8') as f:
    f.writelines(new_lines)
EOF
          echo "âœ… è®¢é˜…åœ°å€å·²åŠ¨æ€æ³¨å…¥åˆ° temp_config/config.yaml"

          # å¯åŠ¨å“¨å…µ (å¼‚æ­¥è¿è¡Œ)
          (
            echo ">>> [å“¨å…µ] å¯åŠ¨æˆåŠŸ..."
            HUNDRED_TIME=0
            while true; do
              sleep 10
              if ! docker ps | grep -q 'checker'; then break; fi
              LOGS=$(docker logs --tail 20 checker 2>&1 | sed 's/\x1b\[[0-9;]*m//g')
              if echo "$LOGS" | grep -qE "ä¿å­˜æœ¬åœ°æˆåŠŸ|èŠ‚ç‚¹ä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜"; then
                docker kill checker || true
                break
              fi
              if echo "$LOGS" | grep -q "100.0%"; then
                HUNDRED_TIME=$((HUNDRED_TIME + 10))
                [ $HUNDRED_TIME -ge 120 ] && { docker kill checker || true; break; }
              else
                HUNDRED_TIME=0
              fi
            done
          ) &

          echo "ğŸš€ å¯åŠ¨å®¹å™¨ï¼ŒæŒ‚è½½ temp_config..."
          # ã€æ³¨æ„ã€‘è¿™é‡Œå¿…é¡»æŒ‚è½½ temp_config æ‰èƒ½è¯†åˆ«åˆ°æ³¨å…¥åçš„è®¢é˜…åœ°å€
          docker run --name checker --rm -t \
            -p 8299:8299 \
            -v ${{ github.workspace }}/temp_config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master || [ $? -eq 137 ] || [ $? -eq 143 ]

          - name: ğŸ” è°ƒè¯•ï¼šæŸ¥çœ‹ç”Ÿæˆçš„é…ç½®
            run: |
            echo "--- ç”Ÿæˆçš„ä¸´æ—¶é…ç½®æ–‡ä»¶å†…å®¹ ---"
            cat ${{ github.workspace }}/temp_config/config.yaml

          # ã€æ–°å¢ã€‘å…³é”®æ­¥éª¤ï¼šåœ¨å®¹å™¨å¯åŠ¨å‰ï¼ŒæŠŠä»“åº“é‡Œçš„æ—§é…ç½®å¡è¿›æŒ‚è½½ç›®å½•
          #echo "ğŸ“‚ æ­£åœ¨é¢„è£…è½½ç°æœ‰é…ç½®..."
          #[ -f "sub-store.json" ] && cp -f sub-store.json ${{ github.workspace }}/output/sub-store.json || echo "é¦–æ¬¡è¿è¡Œï¼Œæ— å¤‡ä»½é…ç½®"
          #[ -f "all.yaml" ] && cp -f all.yaml ${{ github.workspace }}/output/all.yaml || true
          
          # ç»™äºˆæƒé™ç¡®ä¿å®¹å™¨å¯å†™
          #sudo chmod -R 777 ${{ github.workspace }}/output
          
          (
            echo ">>> [å“¨å…µ] å¯åŠ¨æˆåŠŸ..."
            HUNDRED_TIME=0
            while true; do
              sleep 10
              if ! docker ps | grep -q 'checker'; then break; fi
              LOGS=$(docker logs --tail 20 checker 2>&1 | sed 's/\x1b\[[0-9;]*m//g')
              
              if echo "$LOGS" | grep -qE "ä¿å­˜æœ¬åœ°æˆåŠŸ|èŠ‚ç‚¹ä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜"; then
                echo ">>> [å“¨å…µæŠ¥å‘Š] ä»»åŠ¡å®Œæˆï¼æ‰§è¡Œå¼ºåˆ¶æ”¶å‰²..."
                docker kill checker || true
                break
              fi
              
              if echo "$LOGS" | grep -q "100.0%"; then
                HUNDRED_TIME=$((HUNDRED_TIME + 10))
                if [ $HUNDRED_TIME -ge 120 ]; then
                  docker kill checker || true
                  break
                fi
              else
                HUNDRED_TIME=0
              fi
            done
          ) &

          echo "ğŸš€ å¯åŠ¨å®¹å™¨ï¼ŒæŒ‚è½½å·²åŒ…å«æ—§é…ç½®ï¼Œè¿›åº¦å°†å®æ—¶æ˜¾ç¤º..."
          docker run --name checker --rm -t \
            -p 8299:8299 \
            -v ${{ github.workspace }}/temp_config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master || [ $? -eq 137 ] || [ $? -eq 143 ]

      - name: 4. åŒæ­¥ç»“æœå›ä»“åº“ (èŠ‚ç‚¹+é…ç½®)
        run: |

          if [ -f "output/sub-store.json" ]; then
            echo "ğŸ“¤ æ­£åœ¨å¤‡ä»½æœ€æ–°é…ç½®åˆ° KV..."
            curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_KV_ID }}/values/SUB_STORE_CONFIG" \
                 -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
                 --data-binary @output/sub-store.json > /dev/null
            echo "âœ… å¤‡ä»½å®Œæˆ"
          fi
          
          #git config --global user.email "bot@github.com"
          #git config --global user.name "AutoBot"
          
          # åŒæ—¶å¤‡ä»½ all.yaml å’Œ sub-store.json
          #[ -s "output/all.yaml" ] && cp -f output/all.yaml ./all.yaml || true
          #[ -f "output/sub-store.json" ] && cp -f output/sub-store.json ./sub-store.json || true
          
          #git add all.yaml sub-store.json
          #git commit -m "ğŸš€ è‡ªåŠ¨åŒæ­¥ (èŠ‚ç‚¹+é…ç½®): $(date +'%H:%M')" || true
          #git push origin HEAD:${{ github.ref_name }}

      - name: 5. æŒ‚æœºé”å®š (15åˆ†é’Ÿå®æ—¶åŒæ­¥ç½‘é¡µä¿®æ”¹)
        run: |
          # 1. å¯åŠ¨åç«¯å®¹å™¨ (æ­¤æ—¶ output/ æ–‡ä»¶å¤¹é‡Œå·²ç»æ˜¯å¼€å¤´ä» KV æå–çš„æ•°æ®)
          docker rm -f checker >/dev/null 2>&1 || true
          docker run --name checker -d -p 8299:8299 \
            -v ${{ github.workspace }}/temp_config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/aa2283/subs-check:master >/dev/null

          # 2. å‡†å¤‡å¤‡ä»½ä»“åº“ (ä»…ä½œä¸ºä¸Šä¼ ç›®çš„åœ°)
          echo "ğŸ“‚ å‡†å¤‡ç§æœ‰å¤‡ä»½åº“..."
          rm -rf backup_repo
          git clone https://${{ secrets.PAT_TOKEN }}@github.com/aa2283/v2ray_configs.git backup_repo
          
          git config --global user.email "bot@github.com"
          git config --global user.name "AutoBot"
          
          # å»ºç«‹å½“å‰çŠ¶æ€å¿«ç…§ (åŸºäºå¼€å¤´ KV æå–çš„æ•°æ®)
          cp -f output/sub-store.json ./snapshot.json

          # 3. ã€å•å‘å¤‡ä»½å“¨å…µã€‘
          (
            while true; do
              sleep 30
              
              # åªæœ‰ç½‘é¡µç‚¹ä¿å­˜äº† (output/ å˜äº†)ï¼Œæ‰æ‰§è¡Œå¤‡ä»½
              if ! diff -q output/sub-store.json ./snapshot.json >/dev/null 2>&1; then
                echo "ğŸ“¢ æ£€æµ‹åˆ°é…ç½®æ›´æ–°ï¼Œæ­£åœ¨å•å‘åŒæ­¥è‡³ KV å’Œç§æœ‰åº“..."
                cp -f output/sub-store.json ./snapshot.json
                
                # A. å®æ—¶è¦†ç›– KV (ä¿è¯ä¸‹æ¬¡è¿è¡Œå¼€å¤´æå–çš„æ˜¯æœ€æ–°çš„)
                curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.CF_KV_ID }}/values/SUB_STORE_CONFIG" \
                  -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
                  --data-binary @output/sub-store.json > /dev/null
                
                # B. ä¸‹è½½æœ€æ–°èŠ‚ç‚¹æ–‡ä»¶åˆ°ç§æœ‰åº“æ–‡ä»¶å¤¹
                LIST="${{ vars.SUB_LIST || 'zh:ClashMeta' }}"
                IFS=',' read -ra ITEMS <<< "$LIST"
                mkdir -p backup_repo/sub_config/
                for item in "${ITEMS[@]}"; do
                  NAME="${item%%:*}"; TYPE="${item##*:}"
                  [[ "$TYPE" == *"Clash"* ]] && EXT="yaml" || EXT="txt"
                  curl -s "http://127.0.0.1:8299/download/${NAME}?target=${TYPE}" -o "backup_repo/sub_config/${NAME}.${EXT}"
                done

                # C. å¤‡ä»½é…ç½®æ–‡ä»¶ JSON åˆ°ç§æœ‰åº“æ ¹ç›®å½• (ä»…å¤‡ä»½ï¼Œè„šæœ¬ä¸ä»è¿™é‡Œè¯»å–)
                cp -f output/sub-store.json backup_repo/sub_config/sub-store.json

                # D. æ‰§è¡Œæ¨é€
                pushd backup_repo > /dev/null
                git add .
                if [ -n "$(git status --porcelain)" ]; then
                  git commit -m "ğŸ”– ç½‘é¡µå¤‡ä»½: $(date +'%H:%M')"
                  git push origin main || git push origin master
                  echo "âœ… ç§æœ‰åº“å•å‘å¤‡ä»½æˆåŠŸ"
                fi
                popd > /dev/null
              fi
            done
          ) &

          # 4. ä¿æŒè¿è¡Œ
          for i in {15..1}; do
            echo "â³ å“¨å…µå®ˆæŠ¤ä¸­... å‰©ä½™ $i åˆ†é’Ÿ"
            sleep 60
          done
